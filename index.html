<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run – Ultimate Gamer Edition</title>
  <!-- Import Google Font for a retro gaming feel -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- --- AD INTEGRATION START --- -->
  <!-- Social Bar Ad Script (Existing) -->
  <script type='text/javascript' src='//pl26412649.profitableratecpm.com/13/e5/a4/13e5a43804eecf191c995f63cff90d9c.js'></script>
  <!-- --- AD INTEGRATION END --- -->
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; /* Primary font for retro feel */
      overflow: hidden;
      background: #0a0a0a url('https://www.transparenttextures.com/patterns/stardust.png'); /* Subtle starry background */
      color: #fff;
      /* Reserve space for the NEW bottom banner height */
      margin-bottom: 50px;
    }

    canvas { display: block; /* Ensures it takes block-level space */ }

    /* ---------- Enhanced Visual Styling ---------- */
    .text-glow { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff007f; }
    .box-glow { box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 15px rgba(255, 0, 127, 0.5); }

    /* Common button style - More vibrant and game-like */
    .game-btn {
      padding: 12px 25px;
      margin: 10px;
      font-size: 14px; /* Adjusted for Press Start 2P readability */
      border: none; /* Remove default border */
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background: linear-gradient(145deg, #ff4757, #ff6348); /* Vibrant red/orange */
      color: #fff;
      font-family: 'Press Start 2P', cursive;
      text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      border-bottom: 4px solid #c0392b; /* 3D effect */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      display: inline-flex; /* Align items nicely if icon added */
      align-items: center;
      justify-content: center;
      line-height: 1.2; /* Adjust line height for button text */
    }

    .game-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 100, 0.6);
      background: linear-gradient(145deg, #ff6348, #ff7f50); /* Lighter on hover */
    }

    .game-btn:active {
        transform: translateY(1px) scale(1);
        border-bottom-width: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* ---------- Login Panel ---------- */
    #loginPanel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
      background-size: cover; z-index: 100;
      /* display: flex; /* Controlled by JS */
      flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
      background-color: rgba(0,0,0,0.5); /* Darken background image slightly */
    }
    #loginPanel h2 {
      font-size: 2.5em; color: #ff007f; /* Brighter Pink */
      margin-bottom: 30px;
      text-shadow: 3px 3px 0px #000, 0 0 15px #ff007f; /* Stronger shadow + glow */
    }
    #loginPanel input {
      width: 250px; padding: 12px 15px; margin: 8px;
      background: rgba(10, 10, 10, 0.8);
      border: 2px solid #ff007f; color: #fff;
      border-radius: 5px;
      font-family: 'Press Start 2P', cursive; font-size: 14px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
     #loginPanel input:focus {
        border-color: #ff60af;
        box-shadow: 0 0 10px rgba(255, 0, 127, 0.7);
     }
    #loginPanel button { /* These inherit .game-btn via HTML */
      width: 180px;
      background: linear-gradient(145deg, #ff007f, #e60073);
      border-bottom-color: #a70057;
    }
    #loginPanel button:hover {
        background: linear-gradient(145deg, #e60073, #ff309f);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 0, 127, 0.6);
    }

    /* ---------- Main Menu ---------- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center;
      background-size: cover; z-index: 30;
      display: none; /* Initially hidden */
      flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
    }
    #mainMenu h1 {
      font-size: 3.5em; /* Larger Title */
      text-shadow: 4px 4px 0px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.5); /* More prominent shadow */
      margin-bottom: 40px;
      color: #ffe64d; /* Gold color */
    }
    /* Top right coin status with NEW image */
    #topRightStatus {
      position: absolute; top: 15px; right: 15px;
      background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 8px; /* Adjusted padding */
      font-size: 18px; /* Slightly smaller font for Press Start 2P */
      color: #FFD700; /* Gold text */
      z-index: 35;
      border: 2px solid #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      display: inline-flex; /* Align icon and text */
      align-items: center;
    }
    #topRightStatus img#coinIcon { /* Style the NEW image */
      width: 24px; height: 24px;
      margin-right: 8px;
      vertical-align: middle; /* Helps alignment */
    }
    /* Settings button */
    #settingsBtn {
      position: absolute; top: 15px; left: 15px;
      background: rgba(0,0,0,0.8); border: 2px solid #ccc; border-radius: 50%;
      cursor: pointer; z-index: 35;
      width: 45px; height: 45px;
      display: flex; justify-content: center; align-items: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #settingsBtn svg { width: 24px; height: 24px; fill: #fff; }
    #settingsBtn:hover {
        transform: rotate(45deg) scale(1.1);
        box-shadow: 0 0 15px rgba(255,255,255,0.7);
        border-color: #fff;
    }
    /* Use common button style for menu buttons */
    #mainMenu .menu-btn {
      width: 220px; /* Consistent width */
    }
    #mainMenu #withdrawBtn {
        background: linear-gradient(145deg, #2ed573, #1dd1a1); /* Green gradient */
        border-bottom-color: #10ac84;
    }
     #mainMenu #withdrawBtn:hover {
        background: linear-gradient(145deg, #1dd1a1, #00b894);
         box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6);
    }
     #mainMenu #inviteFriend {
        background: linear-gradient(145deg, #54a0ff, #2e86de); /* Blue gradient */
        border-bottom-color: #1e5ea8;
    }
     #mainMenu #inviteFriend:hover {
        background: linear-gradient(145deg, #2e86de, #1e66b0);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(84, 160, 255, 0.6);
    }
     #mainMenu #logoutBtn {
        background: linear-gradient(145deg, #8395a7, #576574); /* Grey gradient */
        border-bottom-color: #2f3640;
    }
    #mainMenu #logoutBtn:hover {
        background: linear-gradient(145deg, #576574, #434c58);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(131, 149, 167, 0.6);
    }

    /* ---------- Game Over Overlay ---------- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); /* Darker overlay */
      z-index: 40;
      display: none; /* Initially hidden */
      flex-direction: column; justify-content: center; align-items: center;
      color: #ff4757; /* Red for game over */
      padding: 20px; text-align: center;
    }
    #gameOverMenu h2 {
      font-size: 4em; /* Much larger */
      text-shadow: 4px 4px 0px #000, 0 0 20px #ff0000; /* Strong red glow */
      margin-bottom: 20px;
    }
    #gameOverMenu p {
        font-size: 1.5em; /* Larger score text */
        color: #fff;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px #000;
    }
    #gameOverMenu .menu-btn { /* Inherit .game-btn */
      width: 200px;
    }
    #gameOverMenu #restartBtn {
        background: linear-gradient(145deg, #2ed573, #1dd1a1); /* Green */
        border-bottom-color: #10ac84;
    }
    #gameOverMenu #backMenuBtn {
        background: linear-gradient(145deg, #54a0ff, #2e86de); /* Blue */
        border-bottom-color: #1e5ea8;
    }

    /* ---------- Modals General Styling ---------- */
    .modal {
        display: none; position: fixed; z-index: 70;
        left: 0; top: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); /* Semi-transparent dark */
        backdrop-filter: blur(5px); /* Optional blur effect */
    }
    .modal .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #1e1e1e; /* Dark grey */
      padding: 20px 25px; /* Adjusted padding */
      border-radius: 10px;
      width: 90%;
      /* Adjusted max-width for slightly smaller modals */
      max-width: 360px; /* Default max-width */
      color: #eee;
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      border: 3px solid #ff007f; /* Pink border */
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 127, 0.4); /* Outer shadow + glow */
    }
    .modal h2 {
        margin-bottom: 20px;
        font-size: 1.4em; /* Slightly smaller title */
        color: #ff007f; /* Match border color */
        text-shadow: 1px 1px 2px #000;
    }
    .modal button.game-btn { /* Apply game button style within modals */
         width: 100%;
         margin: 8px 0; /* Adjust margin for vertical layout */
         padding: 10px 15px; /* Slightly smaller padding */
         font-size: 12px;
    }
    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="password"] {
        width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px;
        border: 2px solid #555; border-radius: 5px;
        background: #333; color: #fff;
        font-family: 'Arial', sans-serif; /* Use Arial for input readability */
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .modal input:focus {
        border-color: #ff007f;
        box-shadow: 0 0 8px rgba(255, 0, 127, 0.6);
    }
    .close-btn {
      position: absolute; top: 10px; right: 15px;
      background: none; border: none; font-size: 28px; cursor: pointer;
      color: #aaa; font-family: Arial, sans-serif; /* Use a standard font for 'X' */
      transition: color 0.2s, transform 0.2s;
      font-weight: bold;
    }
    .close-btn:hover { color: #ff007f; transform: scale(1.2); }

    /* Specific Modal Max Widths */
    #settingsModal .modal-content { max-width: 300px; } /* Settings can be smaller */
    #inviteModal .modal-content { max-width: 360px; }
    #withdrawModal .modal-content { max-width: 380px; } /* Withdraw slightly larger maybe */
    #infoModal .modal-content { max-width: 360px; }

    /* ---------- Settings Modal Specifics ---------- */
    #toggleSound { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #customerService { background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #toggleSound:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #customerService:hover { background: linear-gradient(145deg, #2e86de, #1e66b0); }


    /* ---------- Invite Modal Specifics ---------- */
    #inviteModal .section { margin: 20px 0; border-top: 1px solid #444; padding-top: 15px; }
    #inviteModal .section h3 { font-size: 1.1em; margin-bottom: 10px; color: #eee; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 12px; font-family: Arial, sans-serif; }
    #yourInviteCode {
        font-size: 1.2em; color: #FFD700; background: #333;
        padding: 8px 12px; border-radius: 5px; display: inline-block;
        border: 1px solid #555; word-break: break-all;
    }
    #copyInviteCode { background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #redeemCodeBtn { background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #copyInviteCode:hover { background: linear-gradient(145deg, #ff9f43, #f39c12); }
    #redeemCodeBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }

    /* ---------- Withdraw Modal Specifics ---------- */
    #withdrawModal .modal-content p { margin-bottom: 20px; font-family: Arial, sans-serif; line-height: 1.5; }
    /* NEW Withdraw Button Styling */
    #withdrawModal .redeem-option {
      background: linear-gradient(145deg, #1abc9c, #16a085); /* Teal/Green gradient */
      border-bottom: 4px solid #117a65; /* Darker teal */
      color: #fff;
      padding: 10px 15px; /* Adjust padding */
      margin: 6px 0; /* Adjust margin */
      border-radius: 8px;
      font-size: 13px; /* Slightly adjust font size */
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      width: 100%; /* Ensure full width */
      display: flex; /* Use flex for centering */
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
    }
    #withdrawModal .redeem-option:hover {
       background: linear-gradient(145deg, #1dd1a1, #1abc9c); /* Lighter on hover */
       transform: translateY(-2px);
       box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3), 0 0 15px rgba(26, 188, 156, 0.5);
    }
     #withdrawModal .redeem-option:active {
        transform: translateY(1px);
        border-bottom-width: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
     }
    /* End NEW Withdraw Button Styling */

    #redeemForm {
      display: none; margin-top: 20px;
      font-family: Arial, sans-serif; /* Use Arial for form readability */
      font-size: 16px; line-height: 1.5; text-align: left;
    }
    #redeemForm h3 {
      font-family: 'Press Start 2P', cursive; /* Use game font for sub-heading */
      font-size: 1.2em; color: #eee;
      margin-bottom: 15px; text-align: center;
    }
    #redeemForm label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #redeemForm input[type="text"] { margin-bottom: 15px; } /* Standard styling */
    #redeemForm input[type="radio"] { margin-right: 8px; vertical-align: middle; }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; }
    #redeemForm .payment-options label { margin-bottom: 10px; display: block;}
    #redeemSubmitBtn { /* Inherits .game-btn */
        background: linear-gradient(145deg, #2ed573, #1dd1a1);
        border-bottom-color: #10ac84;
        width: 100%; margin-top: 20px; font-size: 14px;
    }
     #redeemSubmitBtn:hover {
        background: linear-gradient(145deg, #1dd1a1, #00b894);
     }
    #redeemSubmitBtn:disabled {
        background: #555; cursor: not-allowed; border-bottom-color: #333;
    }

    /* ---------- Game Info Modal Specifics ---------- */
    #infoModal .modal-content h2 { color: #54a0ff; } /* Blue title */
    #infoModal .modal-content p {
      margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6;
      color: #ddd; text-align: left;
    }
    #infoModal .modal-content p strong { color: #fff; }


    /* --- AD INTEGRATION STYLING --- */
    /* Banner Ad Container Styling */
    #bannerAdContainer {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 50px;
        background-color: #000; z-index: 1000; display: flex;
        justify-content: center; align-items: center;
        overflow: hidden; border-top: 2px solid #333;
    }
    #bannerAdContainer iframe { max-width: 100%; }

    /* Interstitial Ad Overlay Styling */
    #interstitialAdOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.9); z-index: 2000;
        display: none; flex-direction: column; justify-content: center;
        align-items: center; color: white; text-align: center;
        font-family: 'Press Start 2P', cursive; padding: 20px;
        backdrop-filter: blur(3px);
    }
    #interstitialAdOverlay p#adInfoText {
        font-size: 1.1em; margin-bottom: 25px; color: #eee; line-height: 1.5;
    }
    #interstitialAdCloseButton { /* Inherits .game-btn */
        padding: 12px 25px; font-size: 1em; cursor: pointer;
        background: linear-gradient(145deg, #ff4757, #e84118); /* Red gradient */
        border-bottom-color: #c23616; color: white; border-radius: 8px;
        font-family: 'Press Start 2P', cursive; display: none;
        text-transform: uppercase; margin-top: 20px;
    }
    #interstitialAdCloseButton:hover {
        background: linear-gradient(145deg, #e84118, #d63031);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 71, 87, 0.6);
    }
    #interstitialAdTimer { margin-top: 15px; font-size: 0.9em; color: #ccc; }
     #interstitialAdOverlay p.skip-info {
        font-size: 0.8em; color: #aaa; margin-top: 30px;
        font-family: Arial, sans-serif; line-height: 1.4;
     }
    /* --- AD INTEGRATION END --- */

  </style>
</head>
<body>
  <!-- Hidden audio element for background music -->
  <audio id="backgroundAudio" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/06/21/audio_94dbe2d091.mp3?filename=beats-2-cherry-cute-bgm-271158.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- ---------- Login Panel ---------- -->
  <div id="loginPanel" style="display: none;"> <!-- Initially hidden, shown by JS -->
    <h2>Gamer Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginButton" class="game-btn">Login</button>
    <button id="signupButton" class="game-btn">Sign Up</button>
    <button id="guestButton" class="game-btn">Continue Guest</button>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" style="display: none;"></canvas> <!-- Initially hidden -->

  <!-- ---------- Main Menu ---------- -->
  <div id="mainMenu" style="display: none;"> <!-- Initially hidden -->
    <!-- Settings button at top left -->
    <button id="settingsBtn" title="Open Settings">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6-9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path>
      </svg>
    </button>
    <!-- Top right coin status with NEW image -->
    <div id="topRightStatus">
      <!-- Use the provided Imgur link (direct image link) -->
      <img id="coinIcon" src="https://i.imgur.com/PCDgdlS.png" alt="Coin">
      Coins: <span id="menuCoinCount">0</span>
    </div>
    <h1>Mario Run</h1>
    <button id="startBtn" class="menu-btn game-btn">Play Now</button>
    <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
    <button id="inviteFriend" class="menu-btn game-btn">Invite (0 Refs)</button> <!-- Default Text -->
    <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
    <button id="logoutBtn" class="menu-btn game-btn">Exit Game</button>
  </div>

  <!-- ---------- Settings Modal ---------- -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">×</button>
      <h2>Settings</h2>
      <button id="toggleSound" class="game-btn">Sound: On</button> <!-- Default Text -->
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- ---------- Invite Modal ---------- -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInviteModal">×</button>
      <h2>Invite Friend</h2>
      <div class="section">
        <h3>Your Invite Link</h3>
        <p id="yourInviteCode">Loading...</p> <!-- Will display the code -->
        <button id="copyInviteCode" class="game-btn">Copy Link</button>
      </div>
      <div class="section">
        <h3>Redeem Invite Code</h3>
        <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
        <button id="redeemCodeBtn" class="game-btn">Redeem</button>
      </div>
    </div>
  </div>

  <!-- ---------- Game Over Overlay ---------- -->
  <div id="gameOverMenu" style="display: none;"> <!-- Initially hidden -->
    <h2>Game Over</h2>
    <p>Session Coins: <span id="sessionCoinCount">0</span></p>
    <p>Total Coins: <span id="finalTotalCoins">0</span></p>
    <button id="restartBtn" class="menu-btn game-btn">Restart</button>
    <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- ---------- Withdraw Modal ---------- -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeWithdraw">×</button>
      <h2>Redeem Coins</h2>
      <p>Select an option to redeem your coins:</p>
      <!-- Withdraw options with NEW styling applied via CSS -->
      <div id="redeemOptions">
        <button class="redeem-option" data-coins="10000" data-pkr="100">10000 Coins - 100 PKR</button>
        <button class="redeem-option" data-coins="30000" data-pkr="300">30000 Coins - 300 PKR</button>
        <button class="redeem-option" data-coins="50000" data-pkr="500">50000 Coins - 500 PKR</button>
        <button class="redeem-option" data-coins="80000" data-pkr="800">80,000 Coins - 800 PKR</button>
        <button class="redeem-option" data-coins="100000" data-pkr="1000">100,000 Coins - 1000 PKR</button>
        <button class="redeem-option" data-coins="500000" data-pkr="5000">500,000 Coins - 5000 PKR</button>
      </div>
      <div id="redeemForm" style="display: none;"> <!-- Initially hidden -->
        <h3>Enter Your Details</h3>
        <form id="redeemDetailsForm">
          <div>
            <label for="accountHolderName">Account Holder Name:</label>
            <input type="text" id="accountHolderName" required />
          </div>
          <div>
            <label for="accountNumber">Account Number:</label>
            <input type="text" id="accountNumber" required />
          </div>
          <div class="payment-options" style="margin-top: 15px;">
            <label>Select Payment Method:</label>
            <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
            <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
          </div>
          <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ---------- Game Info Modal ---------- -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">×</button>
      <h2>Game Info</h2>
      <p>
        Welcome to <strong>Mario Run – Ultimate Gamer Edition</strong>. Enjoy endless fun and earn coins while you play!
      </p>
      <p>
        <strong>Online Play:</strong> Log in or sign up to save your coins. Earned coins can be redeemed for rewards!
      </p>
      <p>
        <strong>Offline Play (Guest):</strong> Play for fun! Coins earned as a guest are not saved and cannot be redeemed.
      </p>
        <p>
        <strong>Invite Friends:</strong> Share your invite link. You and your friend both earn bonus coins when they redeem your code! <!-- Limit removed from text -->
      </p>
    </div>
  </div>

  <!-- --- AD INTEGRATION START --- -->
  <!-- Banner Ad Container -->
  <div id="bannerAdContainer">
      <!-- NEW Banner ad script -->
      <script type="text/javascript">
          atOptions = {
              'key' : '84c9a4eabdeffe242051226bdf854fd8',
              'format' : 'iframe',
              'height' : 50,
              'width' : 320,
              'params' : {}
          };
      </script>
      <script type="text/javascript" src="//www.highperformanceformat.com/84c9a4eabdeffe242051226bdf854fd8/invoke.js"></script>
  </div>

  <!-- Interstitial Ad Overlay -->
  <div id="interstitialAdOverlay" style="display: none;"> <!-- Initially hidden -->
      <p id="adInfoText">Advertisement loading in a new tab...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn" style="display: none;">Skip Ad</button>
       <p class="skip-info">(Click 'Skip Ad' to return. You may need to close the ad tab manually.)</p>
  </div>
  <!-- --- AD INTEGRATION END --- -->


  <!-- Firebase and Game Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, push, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    // --- DOM Element References ---
    const loginPanel = document.getElementById('loginPanel');
    const mainMenu = document.getElementById('mainMenu');
    const gameOverMenu = document.getElementById('gameOverMenu');
    const gameCanvas = document.getElementById('gameCanvas');
    const settingsModal = document.getElementById('settingsModal');
    const inviteModal = document.getElementById('inviteModal');
    const withdrawModal = document.getElementById('withdrawModal');
    const infoModal = document.getElementById('infoModal');
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const menuCoinCountSpan = document.getElementById('menuCoinCount');
    const finalTotalCoinsSpan = document.getElementById('finalTotalCoins');
    const sessionCoinCountSpan = document.getElementById('sessionCoinCount');
    const inviteFriendBtn = document.getElementById('inviteFriend');
    const yourInviteCodeP = document.getElementById('yourInviteCode');
    const redeemCodeInput = document.getElementById("redeemCodeInput");
    const toggleSoundBtn = document.getElementById("toggleSound");
    const backgroundAudio = document.getElementById("backgroundAudio");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');


    const firebaseConfig = {
      apiKey: "AIzaSyCxqQEPU7qpEGleQXok7OFAyAouOrccoUY",
      authDomain: "test1-f9ef8.firebaseapp.com",
      databaseURL: "https://test1-f9ef8-default-rtdb.firebaseio.com",
      projectId: "test1-f9ef8",
      storageBucket: "test1-f9ef8.appspot.com",
      messagingSenderId: "709839711061",
      appId: "1:709839711061:web:ae8cc321d2ddac66c91ddc",
      measurementId: "G-K4Q94MBQDT"
    };

    // --- Firebase Initialization ---
    let appFirebase, db, auth;
    try {
        appFirebase = initializeApp(firebaseConfig);
        db = getDatabase(appFirebase);
        auth = getAuth();
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        alert("Critical error: Could not connect to game services. Please refresh or try again later.");
    }


    // --- Global State Variables ---
    let totalCoins = 0;
    let soundEnabled = true;
    let currentUserInviteCode = null;
    let gameStarted = false;
    let gameOver = false;
    let score = 0;
    let mario, obstacles, coins, speed, bgX, platformX;
    let lastJumpInputTime = 0;
    const doubleJumpWindow = 350;
    let canDoubleJump = false;
    let animationFrameId = null;
    let allImagesLoaded = false;


    // --- AD INTEGRATION START ---
    const directLinkUrl = "https://www.profitableratecpm.com/ycus2u5z?key=6d1f652cb3c1d695c1a7cb556f20002a";
    let adCloseTimerInterval;
    let adCloseTimeout;
    let currentAdCallback = null;

    function showInterstitialAd(callback) {
        console.log("showInterstitialAd called");
        if (typeof callback !== 'function') {
            console.error("showInterstitialAd: Invalid callback provided.");
            return;
        }
        currentAdCallback = callback;

        adInfoText.textContent = "Advertisement loading in a new tab...";
        interstitialAdOverlay.style.display = 'flex';
        interstitialAdCloseButton.style.display = 'none';
        interstitialAdTimer.textContent = "";

        try {
             const adWindow = window.open(directLinkUrl, '_blank');
             if (!adWindow) {
                 console.warn("Pop-up blocked?");
                 adInfoText.textContent = "Please disable pop-up blockers to view the ad.";
             }
        } catch (e) {
            console.error("Error opening ad window:", e);
            adInfoText.textContent = "Could not open ad window.";
        }

        let secondsRemaining = 3;
        interstitialAdTimer.textContent = `You can skip in ${secondsRemaining} seconds`;
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        if (adCloseTimeout) clearTimeout(adCloseTimeout);

        adCloseTimerInterval = setInterval(() => {
            secondsRemaining--;
            if (secondsRemaining > 0) {
                interstitialAdTimer.textContent = `You can skip in ${secondsRemaining}s`;
            } else {
                 interstitialAdTimer.textContent = "You can return now.";
                 clearInterval(adCloseTimerInterval);
            }
        }, 1000);

        adCloseTimeout = setTimeout(() => {
            interstitialAdCloseButton.style.display = 'block';
             if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
             interstitialAdTimer.textContent = "You can return now.";
        }, secondsRemaining * 1000 + 100);
    }

    interstitialAdCloseButton.addEventListener('click', () => {
        console.log("Interstitial Close Button clicked");
        interstitialAdOverlay.style.display = 'none';
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        if (adCloseTimeout) clearTimeout(adCloseTimeout);
        interstitialAdTimer.textContent = "";

        if (typeof currentAdCallback === 'function') {
            console.log("Executing ad callback function.");
            try {
                currentAdCallback();
            } catch(e) {
                 console.error("Error executing ad callback:", e);
                 alert("An error occurred after the ad. Please try again.");
            }
            currentAdCallback = null; // Reset callback
        } else {
            console.warn("No valid callback function found after closing ad overlay.");
        }
    });
    // --- AD INTEGRATION END ---


    // --- Authentication Logic ---
    function handleLoginSignupSuccess() {
        console.log("Login/Signup successful, preparing UI transition.");
        showInterstitialAd(() => { // Show ad first
            console.log("Ad callback executing: Loading data and showing main menu.");
            loginPanel.style.display = "none"; // Hide login panel
            loadUserCoins();
            loadInviteCode();
            showMainMenu();
            checkUrlForReferral();
        });
    }

    document.getElementById("loginButton").addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) { alert("Please enter email and password."); return; }
      signInWithEmailAndPassword(auth, email, password)
        .then(handleLoginSignupSuccess) // Call handler on success
        .catch((error) => { console.error("Login Error:", error); alert("Login Error: " + error.message); });
    });

    document.getElementById("signupButton").addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) { alert("Please enter email and password."); return; }
      if (password.length < 6) { alert("Password must be at least 6 characters."); return; }

      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          console.log("Firebase Signup Success:", user.uid);
          return set(ref(db, "users/" + user.uid), { // Set initial data
            email: user.email, uid: user.uid, totalCoins: 0,
            referralCount: 0, referralRedeemed: false
          });
        })
        .then(() => {
             console.log("Initial user data saved.");
             handleLoginSignupSuccess(); // Proceed after data saved
         })
        .catch((error) => {
            console.error("Sign Up or Data Save Error:", error);
            // Check if error is because user already exists during signup
            if (error.code === 'auth/email-already-in-use') {
                 alert("Sign Up Error: This email is already registered. Please log in.");
            } else {
                 alert("Sign Up Error: " + error.message);
            }
        });
    });

    document.getElementById("guestButton").addEventListener("click", () => {
        console.log("Continuing as Guest.");
        loginPanel.style.display = "none";
        resetAppStateToLoggedOut(); // Use reset function
        showMainMenu();
        checkUrlForReferral();
    });

    // --- Auth State Change Listener (Core Logic) ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("onAuthStateChanged: User is signed in:", user.uid);
        if (loginPanel.style.display !== 'flex') {
            console.log("onAuthStateChanged: User already logged in, ensuring main menu.");
            loadUserCoins();
            loadInviteCode();
            showMainMenu(); // Ensure main menu is shown if logged in state persists
            checkUrlForReferral();
        } else {
             console.log("onAuthStateChanged: Login/Signup process will handle UI.");
        }
      } else {
          console.log("onAuthStateChanged: User is signed out.");
          resetAppStateToLoggedOut();
          // Ensure only login panel is visible
          loginPanel.style.display = "flex";
          mainMenu.style.display = "none";
          gameCanvas.style.display = 'none';
          gameOverMenu.style.display = 'none';
          settingsModal.style.display = "none";
          inviteModal.style.display = "none";
          withdrawModal.style.display = "none";
          infoModal.style.display = "none";
      }
    });

    function resetAppStateToLoggedOut() {
        console.log("Resetting app state to logged out.");
        totalCoins = 0;
        currentUserInviteCode = null;
        gameStarted = false;
        gameOver = false;
        score = 0;
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        stopBackgroundMusic();
        menuCoinCountSpan.innerText = "0";
        finalTotalCoinsSpan.innerText = "0"; // Also reset game over total
        updateInviteButtonText(0);
        yourInviteCodeP.textContent = "N/A (Guest)";
        mario = null; obstacles = []; coins = [];
    }


    // --- Data Loading Functions ---
    function loadUserCoins() {
      const user = auth.currentUser;
      if (user) {
        const userRef = ref(db, "users/" + user.uid + "/totalCoins");
        get(userRef).then((snapshot) => {
            totalCoins = snapshot.exists() ? snapshot.val() : 0;
            console.log("Loaded coins:", totalCoins);
            menuCoinCountSpan.innerText = totalCoins;
            finalTotalCoinsSpan.innerText = totalCoins;
        }).catch((error) => {
            console.error("Error loading coins:", error);
            totalCoins = 0; menuCoinCountSpan.innerText = 0; finalTotalCoinsSpan.innerText = 0;
        });
      } else { // Guest
        totalCoins = 0; menuCoinCountSpan.innerText = 0; finalTotalCoinsSpan.innerText = 0;
      }
    }

    function loadInviteCode() {
      const user = auth.currentUser;
      if (user) {
        const userRef = ref(db, "users/" + user.uid);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (!data.inviteCode) {
              const newCode = generateRandomCode();
              set(ref(db, "users/" + user.uid + "/inviteCode"), newCode).then(() => {
                    currentUserInviteCode = newCode; yourInviteCodeP.textContent = newCode;
                }).catch(e => { console.error("Failed to set invite code:", e); yourInviteCodeP.textContent = "Error"; });
            } else {
              currentUserInviteCode = data.inviteCode; yourInviteCodeP.textContent = currentUserInviteCode;
            }
            loadReferralCount();
          } else { // User node doesn't exist? Should be created on signup
              console.warn("User node missing for invite code:", user.uid);
              yourInviteCodeP.textContent = "Error"; currentUserInviteCode = null; loadReferralCount();
          }
        }).catch(e => { console.error("Failed to get user data for invite code:", e); yourInviteCodeP.textContent = "Error"; });
      } else { // Guest
        yourInviteCodeP.textContent = "N/A (Guest)"; currentUserInviteCode = null; updateInviteButtonText(0);
      }
    }

    function loadReferralCount() {
      const user = auth.currentUser;
      if (user) {
        get(ref(db, "users/" + user.uid + "/referralCount")).then((snap) => {
          updateInviteButtonText(snap.exists() ? snap.val() : 0);
        }).catch(e => { console.error("Failed load referral count:", e); updateInviteButtonText(0); });
      } else { updateInviteButtonText(0); }
    }

    function checkUrlForReferral() {
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        if (refCode && auth.currentUser && redeemCodeInput) {
            redeemCodeInput.value = refCode.trim().toUpperCase();
            console.log("Referral code pre-filled:", refCode);
             try { window.history.replaceState({}, document.title, window.location.pathname); }
             catch (e) { console.warn("Could not clean URL:", e); }
        }
    }

    // --- UI Update Functions ---
    function updateInviteButtonText(count) { inviteFriendBtn.innerText = "Invite (" + (count || 0) + " Refs)"; }
    function updateSoundButton() {
        toggleSoundBtn.textContent = `Sound: ${soundEnabled ? 'On' : 'Off'}`;
        // Styles updated via CSS based on class if needed, or keep JS style changes:
        if (soundEnabled) {
            toggleSoundBtn.style.background = 'linear-gradient(145deg, #2ed573, #1dd1a1)';
            toggleSoundBtn.style.borderBottomColor = '#10ac84';
        } else {
            toggleSoundBtn.style.background = 'linear-gradient(145deg, #8395a7, #576574)';
            toggleSoundBtn.style.borderBottomColor = '#2f3640';
        }
    }

    // --- Main Menu Display ---
    function showMainMenu() {
      console.log("Showing Main Menu");
      gameStarted = false; gameOver = false;
      if(animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }

      loginPanel.style.display = "none"; gameOverMenu.style.display = "none";
      gameCanvas.style.display = "none"; settingsModal.style.display = "none";
      inviteModal.style.display = "none"; withdrawModal.style.display = "none";
      infoModal.style.display = "none";

      mainMenu.style.display = "flex"; // Show main menu

      loadUserCoins(); // Refresh coin display
      stopBackgroundMusic();
    }

    // --- Game Over Display ---
     function showGameOverMenu() {
      console.log("Showing Game Over Menu");
      sessionCoinCountSpan.innerText = score;
      finalTotalCoinsSpan.innerText = totalCoins;

      gameOverMenu.style.display = "flex";
      mainMenu.style.display = "none";
      gameCanvas.style.display = 'none'; // Hide canvas on game over
    }


    // --- Sound Logic ---
    backgroundAudio.volume = 0.2;
    function playBackgroundMusic() {
        if (soundEnabled && backgroundAudio.paused) {
            backgroundAudio.play().catch(e => console.log("Audio play blocked:", e));
        }
    }
    function stopBackgroundMusic() {
        if (!backgroundAudio.paused) { backgroundAudio.pause(); backgroundAudio.currentTime = 0; }
    }
    updateSoundButton();


    // --- Settings Modal Logic ---
    document.getElementById("settingsBtn").addEventListener("click", () => { settingsModal.style.display = "block"; });
    document.getElementById("closeSettings").addEventListener("click", () => { settingsModal.style.display = "none"; });
    toggleSoundBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled; updateSoundButton();
      if (!soundEnabled) stopBackgroundMusic();
      else if (gameStarted && !gameOver) playBackgroundMusic();
    });
    document.getElementById("customerService").addEventListener("click", () => { window.open("https://wa.me/923019022815", "_blank"); });


    // --- Invite Friend Logic ---
    const baseInviteUrl = window.location.origin + window.location.pathname;

    function generateRandomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function redeemInviteCode(code) {
      const user = auth.currentUser;
      if (!user) { alert("Please log in."); return; }
      if (code === currentUserInviteCode) { alert("Cannot redeem own code."); return; }

      let referrerId = null;
      let referrerData = null;
      let currentReferralCount = 0; // Initialize here

      get(ref(db, "users/" + user.uid + "/referralRedeemed")).then((redeemedSnap) => {
        if (redeemedSnap.exists() && redeemedSnap.val() === true) { throw new Error("Code already redeemed."); }
        const inviteQuery = query(ref(db, "users"), orderByChild("inviteCode"), equalTo(code));
        return get(inviteQuery);
      }).then((snapshot) => {
        if (!snapshot.exists()) { throw new Error("Invalid invite code."); }
        snapshot.forEach(childSnapshot => {
          if(childSnapshot.key !== user.uid) {
            referrerId = childSnapshot.key;
            referrerData = childSnapshot.val();
          }
        });
        if (!referrerId) { throw new Error("Invalid invite code or self-redemption."); }

        // --- REMOVED REFERRAL LIMIT CHECK ---
        // currentReferralCount = referrerData.referralCount || 0;
        // if (currentReferralCount >= 10) { // This check is now removed/commented out
        //   throw new Error("This referral code has reached its maximum usage (10 users).");
        // }
        // --- END REMOVED CHECK ---
        currentReferralCount = referrerData.referralCount || 0; // Still get the count to increment it

        const redeemerBonus = 200; const referrerBonus = 100;
        let newRedeemerCoins = totalCoins + redeemerBonus;

        return Promise.all([
            set(ref(db, "users/" + user.uid + "/totalCoins"), newRedeemerCoins),
            set(ref(db, "users/" + user.uid + "/referralRedeemed"), true),
            set(ref(db, "users/" + referrerId + "/totalCoins"), (referrerData.totalCoins || 0) + referrerBonus),
            set(ref(db, "users/" + referrerId + "/referralCount"), currentReferralCount + 1) // Increment count
        ]).then(() => ({ newRedeemerCoins, redeemerBonus, referrerBonus }));

      }).then(({ newRedeemerCoins, redeemerBonus, referrerBonus }) => {
          totalCoins = newRedeemerCoins;
          menuCoinCountSpan.innerText = totalCoins;
          finalTotalCoinsSpan.innerText = totalCoins;
          loadReferralCount(); // Refresh count for referrer (UI update if it's the current user)
          alert(`Code redeemed! You got ${redeemerBonus} coins. Referrer got ${referrerBonus} coins.`);
          inviteModal.style.display = "none"; redeemCodeInput.value = "";
      }).catch(error => {
          console.error("Error redeeming code:", error); alert("Error: " + error.message);
      });
    }

    // Invite Modal Listeners
    inviteFriendBtn.addEventListener("click", () => {
      if (!auth.currentUser) { alert("Please log in."); return; }
      loadInviteCode(); inviteModal.style.display = "block";
    });
    document.getElementById("closeInviteModal").addEventListener("click", () => { inviteModal.style.display = "none"; });
    document.getElementById("copyInviteCode").addEventListener("click", () => {
       if (currentUserInviteCode && currentUserInviteCode !== "Loading..." && currentUserInviteCode !== "N/A (Guest)" && currentUserInviteCode !== "Error") {
            const inviteLink = `${baseInviteUrl}?ref=${currentUserInviteCode}`;
            navigator.clipboard.writeText(inviteLink).then(() => alert("Invite link copied!"))
             .catch(err => { alert("Failed to copy."); console.error('Copy failed: ', err); });
       } else { alert("Invite link not available."); }
    });
    document.getElementById("redeemCodeBtn").addEventListener("click", () => {
      const code = redeemCodeInput.value.trim().toUpperCase();
      if (code) redeemInviteCode(code); else alert("Please enter code.");
    });


    // --- Withdraw Modal Logic ---
    let selectedWithdrawCoins = 0;
    let selectedWithdrawPKR = 0;

    document.getElementById("withdrawBtn").addEventListener("click", () => {
        if (!auth.currentUser) { alert("Please log in."); return; }
        loadUserCoins(); // Refresh balance
        redeemOptionsDiv.style.display = "block"; redeemFormDiv.style.display = "none";
        redeemDetailsForm.reset(); redeemSubmitBtn.disabled = false;
        redeemSubmitBtn.textContent = "Submit Request";
        withdrawModal.style.display = "block";
    });
    document.getElementById("closeWithdraw").addEventListener("click", () => { withdrawModal.style.display = "none"; });
    redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
      button.addEventListener('click', () => {
        selectedWithdrawCoins = parseInt(button.getAttribute('data-coins'), 10);
        selectedWithdrawPKR = parseInt(button.getAttribute('data-pkr'), 10);
        if (totalCoins < selectedWithdrawCoins) {
            alert(`Insufficient coins! Need ${selectedWithdrawCoins}.`); return;
        }
        redeemOptionsDiv.style.display = 'none'; redeemFormDiv.style.display = 'block';
      });
    });
    redeemDetailsForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const accountHolderName = document.getElementById('accountHolderName').value.trim();
      const accountNumber = document.getElementById('accountNumber').value.trim();
      const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');
      if (!accountHolderName || !accountNumber || !paymentMethodInput) { alert("Please complete the form."); return; }
      if (totalCoins < selectedWithdrawCoins) { alert("Error: Insufficient coins."); withdrawModal.style.display = "none"; return; }

      const user = auth.currentUser; if (!user) { alert("Auth error."); withdrawModal.style.display = "none"; return; }
      const paymentMethod = paymentMethodInput.value;
      const withdrawalRequest = { /* ... data ... */
         uid: user.uid, email: user.email || "N/A", withdrawalAmountCoins: selectedWithdrawCoins,
         pkrAmount: selectedWithdrawPKR, accountHolderName, accountNumber, paymentMethod,
         status: "pending", timestamp: Date.now()
      };

      redeemSubmitBtn.disabled = true; redeemSubmitBtn.textContent = "Submitting...";

      push(ref(db, "withdrawRequests"), withdrawalRequest)
        .then(() => set(ref(db, "users/" + user.uid + "/totalCoins"), totalCoins - selectedWithdrawCoins))
        .then(() => {
            totalCoins -= selectedWithdrawCoins; // Update local state AFTER success
            menuCoinCountSpan.innerText = totalCoins; finalTotalCoinsSpan.innerText = totalCoins;
            alert(`Request for ${selectedWithdrawPKR} PKR submitted!`);
            withdrawModal.style.display = "none";
        })
        .catch((error) => {
            alert("Error submitting request: " + error.message); console.error("Withdrawal error:", error);
            redeemSubmitBtn.disabled = false; redeemSubmitBtn.textContent = "Submit Request"; // Re-enable on failure
        });
    });

    // --- Info Modal Logic ---
    document.getElementById("infoBtn").addEventListener("click", () => { infoModal.style.display = "block"; });
    document.getElementById("closeInfo").addEventListener("click", () => { infoModal.style.display = "none"; });

    // --- Logout Logic ---
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).catch((error) => { alert("Logout error: " + error.message); });
      // Auth listener handles UI reset
    });


    // --- Game Engine Code ---
    const ctx = gameCanvas.getContext("2d");

    function resizeCanvas() {
        gameCanvas.width = window.innerWidth;
        const bannerHeight = document.getElementById('bannerAdContainer')?.offsetHeight || 50;
        gameCanvas.height = window.innerHeight - bannerHeight;
        if (gameStarted && mario) { // Adjust Mario if game running
             const groundY = gameCanvas.height - 50;
             if (mario.y + mario.height >= groundY - 5 || !mario.isJumping) {
                 mario.y = groundY - mario.height; mario.dy = 0;
                 mario.isJumping = false; canDoubleJump = false;
             }
        }
    }
    window.addEventListener("resize", resizeCanvas);

    // --- Image Loading ---
    const imagesToLoad = { character: "https://i.imgur.com/AbfH2aB.png", background: "https://i.imgur.com/xZpZqGt.png",
                           enemy: "https://i.imgur.com/TsR4WXH.png", coin: "https://i.imgur.com/cMQ9X0d.png", platform: "https://i.imgur.com/06ptzal.png" };
    const gameImages = {};
    let imagesLoadedCount = 0; let totalImagesToLoad = Object.keys(imagesToLoad).length;

    function checkAllImagesLoaded() {
        imagesLoadedCount++;
        if (imagesLoadedCount === totalImagesToLoad) { allImagesLoaded = true; console.log("All game images loaded."); }
    }
    for (const key in imagesToLoad) {
        gameImages[key] = new Image(); gameImages[key].onload = checkAllImagesLoaded;
        gameImages[key].onerror = () => { console.error("Failed to load image:", key); totalImagesToLoad--; };
        gameImages[key].src = imagesToLoad[key];
    }
    // --- End Image Loading ---

    function initGame() {
      if (!allImagesLoaded) { alert("Assets loading..."); return; }
      console.log("Initializing game...");
      resizeCanvas();
      bgX = 0; platformX = 0;
      const groundY = gameCanvas.height - 50;
      mario = { x: 60, y: groundY - 60, width: 40, height: 60, dy: 0, gravity: 1.6, jumpPower: -22, doubleJumpPower: -18, isJumping: false };
      obstacles = []; coins = []; speed = 6; score = 0;
      gameOver = false; gameStarted = true; lastJumpInputTime = 0; canDoubleJump = false;

      if(animationFrameId) cancelAnimationFrame(animationFrameId);
      playBackgroundMusic();
      gameLoop();
    }

    function drawBackground() { /* ... same as before ... */
      if (!gameImages.background?.complete || gameImages.background.naturalWidth === 0) return;
      bgX = (bgX - speed * 0.4) % gameImages.background.width;
      ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, gameCanvas.height);
      ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, gameCanvas.height);
    }
    function drawPlatform() { /* ... same as before ... */
       if (!gameImages.platform?.complete || gameImages.platform.naturalWidth === 0) return;
       const groundY = gameCanvas.height - 50;
       platformX = (platformX - speed) % gameImages.platform.width;
       ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50);
       ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50);
    }
    function drawMario() { /* ... same as before ... */
       if (!mario || !gameImages.character?.complete || gameImages.character.naturalWidth === 0) return;
       ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height);
    }
    function drawObstacles() { /* ... same as before ... */
      if (!gameImages.enemy?.complete || gameImages.enemy.naturalWidth === 0) return;
      for (let i = obstacles.length - 1; i >= 0; i--) {
        let obs = obstacles[i]; obs.x -= speed;
        ctx.drawImage(gameImages.enemy, obs.x, obs.y, obs.width, obs.height);
        if (obs.x + obs.width < 0) obstacles.splice(i, 1);
      }
    }
     function spawnObstacles() { /* ... same as before ... */
        if (gameOver || !gameImages.enemy?.complete) return;
        const minDistance=350, maxDistance=650;
        const scoreFactor=Math.max(0.1, 1-(score/600));
        const distanceRange=(maxDistance-minDistance)*scoreFactor;
        const randomDistance=minDistance+Math.random()*distanceRange;
        let lastObstacleX = obstacles.length > 0 ? obstacles[obstacles.length - 1].x : -randomDistance;
        if (gameCanvas.width - lastObstacleX > randomDistance && obstacles.length < 5) {
            const groundY = gameCanvas.height - 50;
            obstacles.push({ x: gameCanvas.width + 10, y: groundY - 50, width: 50, height: 50 });
        }
    }
    function drawCoins() { /* ... same as before ... */
        if (!gameImages.coin?.complete || !mario) return;
        const user = auth.currentUser;
        for (let i = coins.length - 1; i >= 0; i--) {
            let coin = coins[i]; coin.x -= speed;
            ctx.drawImage(gameImages.coin, coin.x - coin.width / 2, coin.y - coin.height / 2, coin.width, coin.height);
            if ( mario.x < coin.x + coin.width / 2 && mario.x + mario.width > coin.x - coin.width / 2 &&
                 mario.y < coin.y + coin.height / 2 && mario.y + mario.height > coin.y - coin.height / 2 ) {
                coins.splice(i, 1); score += 1;
                if (user) { totalCoins += 1; finalTotalCoinsSpan.innerText = totalCoins; } // Update total immediately
            } else if (coin.x + coin.width < 0) { coins.splice(i, 1); }
        }
    }
     function spawnCoins() { /* ... same as before ... */
        if (!gameImages.coin?.complete) return; const spawnChance = 0.025;
        if (coins.length < 25 && Math.random() < spawnChance) {
            const groundY=gameCanvas.height-50; let spawnY=groundY-30; if(Math.random()<0.4)spawnY=groundY-80-(Math.random()*60);
            let clusterSize=Math.floor(Math.random()*4)+2; let startX=gameCanvas.width+Math.random()*100; const spacing=45;
            for(let i=0;i<clusterSize;i++) coins.push({x:startX+i*spacing, y:spawnY, width:25, height:25});
        }
    }
    function applyPhysics() { /* ... same as before ... */
        if (!mario) return; mario.dy += mario.gravity; mario.y += mario.dy;
        const groundY = gameCanvas.height - 50;
        if (mario.y + mario.height >= groundY) {
            mario.y=groundY-mario.height; mario.dy=0; if(mario.isJumping){mario.isJumping=false; canDoubleJump=false;}
        } if (mario.y < 0) { mario.y = 0; mario.dy = 0; }
    }
    function checkCollision() { /* ... same as before ... */
      if (!mario || gameOver) return;
      for (let i=obstacles.length-1; i>=0; i--) { let obs=obstacles[i];
        if (mario.x<obs.x+obs.width&&mario.x+mario.width>obs.x&&mario.y<obs.y+obs.height&&mario.y+mario.height>obs.y) {
          gameOver=true; stopBackgroundMusic(); console.log("Collision!"); break; } }
    }
    function jump() { /* ... same as before ... */
        if(!gameStarted||gameOver||!mario)return; const currentTime=Date.now(); const groundY=gameCanvas.height-50; const onGround=mario.y+mario.height>=groundY-5;
        if(mario.isJumping&&canDoubleJump&&(currentTime-lastJumpInputTime<doubleJumpWindow)){ mario.dy=mario.doubleJumpPower; canDoubleJump=false; lastJumpInputTime=0; console.log("Double Jump!");}
        else if(onGround){mario.dy=mario.jumpPower; mario.isJumping=true; canDoubleJump=true; lastJumpInputTime=currentTime; console.log("First Jump!");}
    }

    // --- Game Loop ---
    function gameLoop() {
        if (gameOver || !gameStarted) { if(gameOver) handleGameOver(); return; }
        applyPhysics(); checkCollision(); if(gameOver){handleGameOver(); return;}
        spawnObstacles(); spawnCoins();
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        drawBackground(); drawPlatform(); drawObstacles(); drawCoins(); drawMario();
        ctx.fillStyle="#FFF"; ctx.font="20px 'Press Start 2P'"; ctx.textAlign="left"; ctx.textBaseline="top";
        ctx.shadowColor='black'; ctx.shadowBlur=4; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
        ctx.fillText("Score: "+score, 20, 20); ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    function handleGameOver() {
         console.log("Handling Game Over. Score:", score);
         gameStarted = false; const user = auth.currentUser;
         if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
         stopBackgroundMusic();
         if (user && score > 0) {
             set(ref(db, "users/" + user.uid + "/totalCoins"), totalCoins)
                .then(() => console.log("Final coins saved."))
                .catch(e => console.error("Error saving coins:", e));
         } else { console.log("Game Over - coins not saved."); }
         showGameOverMenu();
    }

    // --- Game Control Button Listeners ---
    document.getElementById("startBtn").addEventListener("click", () => {
        if (!allImagesLoaded) { alert("Assets loading..."); return; }
        showInterstitialAd(() => {
            mainMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame();
        });
    });
    document.getElementById("restartBtn").addEventListener("click", () => {
        if (!allImagesLoaded) { alert("Assets error."); showMainMenu(); return; }
         showInterstitialAd(() => {
             gameOverMenu.style.display = "none"; gameCanvas.style.display = 'block'; initGame();
         });
    });
    document.getElementById("backMenuBtn").addEventListener("click", showMainMenu);

    // --- Jump Event Listeners ---
    document.addEventListener("keydown", (e) => { if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("click", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } });
    gameCanvas.addEventListener("touchstart", (e) => { if (gameStarted && !gameOver) { e.preventDefault(); jump(); } }, { passive: false });

    // --- Initial Setup ---
    console.log("Running initial setup...");
    // Auth listener will handle initial view
    loginPanel.style.display = "none"; mainMenu.style.display = "none";
    gameCanvas.style.display = "none"; gameOverMenu.style.display = "none";

  </script>
</body>
</html>