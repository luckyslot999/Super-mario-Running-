<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run – Ultimate Gamer Edition</title>
  <!-- Import Google Font for a retro gaming feel -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- --- AD INTEGRATION START --- -->
  <!-- Social Bar Ad Script -->
  <script type='text/javascript' src='//pl26412649.profitableratecpm.com/13/e5/a4/13e5a43804eecf191c995f63cff90d9c.js'></script>
  <!-- --- AD INTEGRATION END --- -->
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; overflow: hidden; background: #000; margin-bottom: 90px; /* Reserve space for bottom banner */ }
    canvas { display: block; }

    /* ---------- Login Panel ---------- */
    #loginPanel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
      background-size: cover; z-index: 100;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
    }
    #loginPanel h2 {
      font-family: 'Press Start 2P', cursive; font-size: 2em; color: #ff007f;
      margin-bottom: 20px; text-shadow: 2px 2px 4px #000;
    }
    #loginPanel input {
      width: 220px; padding: 10px; margin: 5px;
      background: #111; border: 2px solid #ff007f; color: #fff;
      border-radius: 5px; font-family: 'Press Start 2P', cursive; font-size: 14px;
    }
    #loginPanel button {
      width: 130px; padding: 8px 16px; margin: 10px;
      background: linear-gradient(45deg, #ff007f, #e60073);
      border: none; color: #fff; cursor: pointer; border-radius: 5px;
      font-family: 'Press Start 2P', cursive; text-transform: uppercase; font-size: 14px;
    }

    /* ---------- Main Menu ---------- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center;
      background-size: cover; z-index: 30;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
    }
    #mainMenu h1 {
      font-family: 'Press Start 2P', cursive; font-size: 2.5em;
      text-shadow: 3px 3px 5px rgba(0,0,0,0.8); margin-bottom: 30px;
    }
    /* Top right coin status with coin icon */
    #topRightStatus {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 8px;
      font-size: 20px; color: #fff; z-index: 35;
      font-family: 'Press Start 2P', cursive;
    }
    #topRightStatus svg {
      width: 20px; height: 20px; vertical-align: middle;
      fill: #FFD700; margin-right: 5px;
    }
    /* Settings button using a professional gear icon */
    #settingsBtn {
      position: absolute; top: 10px; left: 10px;
      background: none; border: none; cursor: pointer; z-index: 35;
    }
    #settingsBtn svg {
      width: 28px; height: 28px; fill: #fff;
    }
    /* Common menu button style */
    .menu-btn {
      padding: 10px 20px; margin: 10px; font-size: 14px;
      border: 2px solid #fff; border-radius: 8px; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      background: linear-gradient(45deg, red, orange); color: #fff;
      font-family: 'Press Start 2P', cursive; text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .menu-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.8); }
    /* Invite Friend button – its text will display the referral count */
    #inviteFriend { }

    /* ---------- Game Over Overlay ---------- */
    #gameOverMenu {
      /* display: none; */ /* Controlled by JS */
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.65); z-index: 40;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
      display: none; /* Initially hidden */
    }
    #gameOverMenu h2 {
      font-family: 'Press Start 2P', cursive; font-size: 3em;
      text-shadow: 2px 2px 4px #000;
    }

    /* ---------- Settings Modal ---------- */
    #settingsModal {
      display: none; position: fixed; z-index: 70;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #settingsModal .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: #111; padding: 20px;
      border-radius: 5px; width: 90%; max-width: 300px; color: #fff;
      text-align: center; font-family: 'Press Start 2P', cursive;
    }
    #settingsModal h2 { margin-bottom: 15px; font-size: 20px; }
    #settingsModal button {
      display: block; width: 100%; margin: 10px 0; padding: 10px;
      border: none; border-radius: 5px; cursor: pointer;
      font-size: 16px; text-transform: uppercase;
    }
    #toggleSound { background: linear-gradient(45deg, #32CD32, #7CFC00); color: #000; }
    #customerService { background: linear-gradient(45deg, #1E90FF, #00BFFF); color: #fff; }
    #closeSettings {
      position: absolute; top: 5px; right: 10px;
      background: none; border: none; font-size: 24px; cursor: pointer; color: #fff;
    }

    /* ---------- Invite Modal ---------- */
    #inviteModal {
      display: none; position: fixed; z-index: 70;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #inviteModal .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: #111; padding: 20px;
      border-radius: 5px; width: 90%; max-width: 350px; color: #fff;
      text-align: center; font-family: 'Press Start 2P', cursive;
    }
    #inviteModal h2 { margin-bottom: 15px; font-size: 20px; }
    #inviteModal .section {
      margin: 15px 0;
    }
    #inviteModal .section h3 { font-size: 18px; margin-bottom: 8px; }
    #inviteModal .section p { font-size: 16px; margin-bottom: 8px; }
    #inviteModal input {
      width: 100%; padding: 8px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 5px;
      background: #222; color: #fff;
      font-family: Arial, sans-serif; font-size: 16px;
    }
    #inviteModal button { /* re-use .menu-btn styling */ }

    /* ---------- Withdraw Modal ---------- */
    #withdrawModal {
      display: none; position: fixed; z-index: 50; left: 0; top: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.5);
    }
    #withdrawModal .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: #111; padding: 20px;
      border-radius: 5px; width: 90%; max-width: 400px; color: #fff;
      font-family: 'Press Start 2P', cursive; text-align: center;
    }
    #withdrawModal .modal-content h2 { margin-bottom: 15px; }
    #withdrawModal .modal-content p { margin-bottom: 20px; }
    #withdrawModal .modal-content .redeem-option {
      width: 100%; padding: 10px; margin: 5px 0;
      background: linear-gradient(45deg, #32CD32, #7CFC00);
      border: none; color: #000; cursor: pointer; border-radius: 5px;
      font-family: 'Press Start 2P', cursive; font-size: 14px; text-transform: uppercase;
    }
    /* Additional details form styling */
    #redeemForm {
      display: none; margin-top: 20px; font-family: Arial, sans-serif;
      font-size: 16px; line-height: 1.5; text-align: left;
    }
    #redeemForm h3 {
      font-family: Arial, sans-serif; font-size: 18px;
      margin-bottom: 10px; text-align: center;
    }
    #redeemForm label, #redeemForm input, #redeemForm p {
      font-family: Arial, sans-serif; font-size: 16px;
    }
    #redeemForm input {
      width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc;
      border-radius: 5px; background: #222; color: #fff;
    }
    #redeemForm button {
      width: 100%; padding: 10px; margin-top: 15px;
      background: linear-gradient(45deg, #32CD32, #7CFC00);
      border: none; border-radius: 5px; font-family: Arial, sans-serif;
      font-size: 16px; cursor: pointer; color: #000;
    }

    .close-btn {
      position: absolute; top: 5px; right: 10px;
      background: none; border: none; font-size: 24px; cursor: pointer; color: #fff;
    }

    /* ---------- Game Info Modal ---------- */
    #infoModal {
      display: none; position: fixed; z-index: 60; left: 0; top: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.5);
    }
    #infoModal .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: #111; padding: 20px;
      border-radius: 5px; width: 90%; max-width: 400px; color: #fff;
      font-family: Arial, sans-serif; font-size: 16px; line-height: 1.5; text-align: center;
    }
    #infoModal .modal-content h2 {
      margin-bottom: 15px; font-family: Arial, sans-serif; font-size: 1.8em;
    }
    #infoModal .modal-content p {
      margin: 10px 0; font-family: Arial, sans-serif; font-size: 16px;
    }

    /* --- AD INTEGRATION START --- */
    /* Banner Ad Container Styling */
    #bannerAdContainer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 90px; /* Height specified in the ad script */
        background-color: #000; /* Optional background */
        z-index: 1000; /* Ensure it's above most elements */
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden; /* Prevent ad content from spilling */
    }

    /* Interstitial Ad Overlay Styling */
    #interstitialAdOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85); /* Dark overlay */
        z-index: 2000; /* Above everything else */
        display: none; /* Hidden by default */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        font-family: 'Press Start 2P', cursive;
        padding: 20px; /* Add padding */
    }
    #interstitialAdOverlay p#adInfoText { /* Specific ID for text */
        font-size: 1.1em; /* Adjusted size */
        margin-bottom: 20px;
    }
    #interstitialAdCloseButton {
        padding: 12px 25px; /* Slightly larger button */
        font-size: 1em;
        cursor: pointer;
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 5px;
        font-family: 'Press Start 2P', cursive;
        display: none; /* Hidden until timer finishes */
        text-transform: uppercase;
    }
    #interstitialAdTimer {
        margin-top: 15px;
        font-size: 0.9em;
        color: #ccc; /* Lighter color for timer */
    }
    /* --- AD INTEGRATION END --- */

  </style>
</head>
<body>
  <!-- Hidden audio element for background music -->
  <audio id="backgroundAudio" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/06/21/audio_94dbe2d091.mp3?filename=beats-2-cherry-cute-bgm-271158.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- ---------- Login Panel ---------- -->
  <div id="loginPanel">
    <h2>Gamer Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginButton">Login</button>
    <button id="signupButton">Sign Up</button>
    <!-- Guest option -->
    <button id="guestButton">Continue Guest</button>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- ---------- Main Menu ---------- -->
  <div id="mainMenu" style="display: none;"> <!-- Initially hidden, shown after login/guest or ad -->
    <!-- Settings button at top left -->
    <button id="settingsBtn" title="Open Settings">
      <!-- Professional gear icon SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6-9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path>
      </svg>
    </button>
    <!-- Top right coin status with coin icon -->
    <div id="topRightStatus">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
        <path d="M552 64H24C10.7 64 0 74.7 0 88v336c0 13.3 10.7 24 24 24h528c13.3 0 24-10.7 24-24V88c0-13.3-10.7-24-24-24zM192 360c-35.3 0-64-28.7-64-64s28.7-64 64-64 64 28.7 64 64-28.7 64-64 64zm192 0c-35.3 0-64-28.7-64-64s28.7-64 64-64 64 28.7 64 64-28.7 64-64 64z"></path>
      </svg>
      Coins: <span id="menuCoinCount">0</span>
    </div>
    <h1>Mario Run</h1> <!-- Added Title -->
    <button id="startBtn" class="menu-btn">Play Now</button>
    <button id="withdrawBtn" class="menu-btn">withdraw Coins</button>
    <button id="inviteFriend" class="menu-btn">Invite Friend</button>
    <button id="infoBtn" class="menu-btn">Game Info</button>
    <button id="logoutBtn" class="menu-btn">Exit Game</button>
  </div>

  <!-- ---------- Settings Modal ---------- -->
  <div id="settingsModal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">×</button>
      <h2>Settings</h2>
      <button id="toggleSound" class="menu-btn">Sound: On</button>
      <button id="customerService" class="menu-btn">Customer Service</button>
    </div>
  </div>

  <!-- ---------- Invite Modal ---------- -->
  <div id="inviteModal">
    <div class="modal-content">
      <button class="close-btn" id="closeInviteModal">×</button>
      <h2>Invite Friend</h2>
      <div class="section">
        <h3>Your Invite Code</h3>
        <p id="yourInviteCode">Loading...</p>
        <!-- UPDATED: Button text changed -->
        <button id="copyInviteCode" class="menu-btn">Copy Link</button>
      </div>
      <div class="section">
        <h3>Redeem Invite Code</h3>
        <input type="text" id="redeemCodeInput" placeholder="Enter invite code" />
        <button id="redeemCodeBtn" class="menu-btn">Redeem</button>
      </div>
    </div>
  </div>

  <!-- ---------- Game Over Overlay ---------- -->
  <div id="gameOverMenu">
    <h2>Game Over</h2>
    <p>Session Coins: <span id="sessionCoinCount">0</span></p>
    <p>Total Coins: <span id="finalTotalCoins">0</span></p>
    <button id="restartBtn" class="menu-btn">Restart</button>
    <button id="backMenuBtn" class="menu-btn">Back to Menu</button>
  </div>

  <!-- ---------- Withdraw Modal ---------- -->
  <div id="withdrawModal">
    <div class="modal-content">
      <button class="close-btn" id="closeWithdraw">×</button>
      <h2>Redeem Coins</h2>
      <p>Select an option to redeem your coins:</p>
      <div id="redeemOptions">
        <button class="redeem-option" data-coins="10000" data-pkr="100">10000 Coins - 100PKR</button>
        <button class="redeem-option" data-coins="30000" data-pkr="300">30000 Coins - 300PKR</button>
        <button class="redeem-option" data-coins="50000" data-pkr="500">50000 Coins - 500PKR</button>
        <button class="redeem-option" data-coins="80000" data-pkr="800">80,000 - 800PKR</button>
        <button class="redeem-option" data-coins="100000" data-pkr="1000">100,000- 1000PKR</button>
        <button class="redeem-option" data-coins="500000" data-pkr="5000">500,000 - 5000PKR</button>
      </div>
      <div id="redeemForm">
        <h3>Enter Your Details</h3>
        <form id="redeemDetailsForm">
          <div>
            <label for="accountHolderName">Account Holder Name:</label><br>
            <input type="text" id="accountHolderName" required />
          </div>
          <div style="margin-top:10px;">
            <label for="accountNumber">Account Number:</label><br>
            <input type="text" id="accountNumber" required />
          </div>
          <div style="margin-top:10px;">
            <p>Select Payment Method:</p>
            <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label><br>
            <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
          </div>
          <button type="submit" id="redeemSubmitBtn">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ---------- Game Info Modal ---------- -->
  <div id="infoModal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">×</button>
      <h2>Game Info</h2>
      <p>
        Welcome to Mario Run – Ultimate Gamer Edition. Enjoy endless fun and earn coins while you play.
      </p>
      <p>
        Online play :- If you play the online game, all the coins you earn will be stored and redeemable.
      </p>
      <p>
        Offline play :- If you play offline, you can only have fun; coins will not be stored.
      </p>
    </div>
  </div>

  <!-- --- AD INTEGRATION START --- -->
  <!-- Banner Ad Container -->
  <div id="bannerAdContainer">
      <!-- Banner ad script will be placed here by JS or directly -->
      <script type="text/javascript">
          atOptions = {
              'key' : 'fb7872686a71ed88cf6eb3b1ca694702',
              'format' : 'iframe',
              'height' : 90,
              'width' : 728, // Note: This width might be wider than mobile screens. The container will center it.
              'params' : {}
          };
      </script>
      <script type="text/javascript" src="//www.highperformanceformat.com/fb7872686a71ed88cf6eb3b1ca694702/invoke.js"></script>
      <!-- Native banner ad container (if needed, place its script here too) -->
      <!-- <div id="container-efcaaeb9f4d71ef5c769f8c7749658d3"></div> -->
      <!-- <script async="async" data-cfasync="false" src="//pl26411836.profitableratecpm.com/efcaaeb9f4d71ef5c769f8c7749658d3/invoke.js"></script> -->
  </div>

  <!-- Interstitial Ad Overlay -->
  <div id="interstitialAdOverlay">
      <p id="adInfoText">Advertisement loading in a new tab...</p>
      <button id="interstitialAdCloseButton">Skip Ad</button> <!-- This button closes THIS overlay -->
      <div id="interstitialAdTimer"></div>
       <p style="font-size: 0.8em; color: #aaa; margin-top: 25px;">(Click 'Skip Ad' to return to the game. You may need to close the ad tab manually afterwards.)</p>
  </div>
  <!-- --- AD INTEGRATION END --- -->


  <!-- Firebase and Game Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, push, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCxqQEPU7qpEGleQXok7OFAyAouOrccoUY", // WARNING: Consider securing this key
      authDomain: "test1-f9ef8.firebaseapp.com",
      databaseURL: "https://test1-f9ef8-default-rtdb.firebaseio.com",
      projectId: "test1-f9ef8",
      storageBucket: "test1-f9ef8.appspot.com", // Corrected bucket name
      messagingSenderId: "709839711061",
      appId: "1:709839711061:web:ae8cc321d2ddac66c91ddc",
      measurementId: "G-K4Q94MBQDT"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const db = getDatabase(appFirebase);
    const auth = getAuth();

    // --- AD INTEGRATION START ---
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const directLinkUrl = "https://www.profitableratecpm.com/ycus2u5z?key=6d1f652cb3c1d695c1a7cb556f20002a";
    let adCloseTimerInterval;
    let adCloseTimeout;
    let currentAdCallback = null;

    function showInterstitialAd(callback) {
        console.log("showInterstitialAd called");
        currentAdCallback = callback;

        adInfoText.textContent = "Advertisement loading in a new tab...";
        interstitialAdOverlay.style.display = 'flex';
        interstitialAdCloseButton.style.display = 'none';
        interstitialAdTimer.textContent = "";

        try {
             const adWindow = window.open(directLinkUrl, '_blank');
             if (!adWindow) {
                 console.warn("Pop-up blocked? Could not open ad window.");
                 adInfoText.textContent = "Please disable pop-up blockers to view the ad.";
             }
        } catch (e) {
            console.error("Error opening ad window:", e);
            adInfoText.textContent = "Could not open ad window.";
        }

        let secondsRemaining = 3;
        interstitialAdTimer.textContent = `You can skip in ${secondsRemaining} seconds`;

        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        if (adCloseTimeout) clearTimeout(adCloseTimeout);

        adCloseTimerInterval = setInterval(() => {
            secondsRemaining--;
            if (secondsRemaining > 0) {
                interstitialAdTimer.textContent = `You can skip in ${secondsRemaining} second${secondsRemaining > 1 ? 's' : ''}`;
            } else {
                 interstitialAdTimer.textContent = "You can return to the game now.";
                 clearInterval(adCloseTimerInterval);
            }
        }, 1000);

        adCloseTimeout = setTimeout(() => {
            interstitialAdCloseButton.style.display = 'block';
             if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
             interstitialAdTimer.textContent = "You can return to the game now.";
        }, 3000);
    }

    interstitialAdCloseButton.addEventListener('click', () => {
        console.log("Interstitial Close Button clicked");
        interstitialAdOverlay.style.display = 'none';
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        if (adCloseTimeout) clearTimeout(adCloseTimeout);
        interstitialAdTimer.textContent = "";

        if (typeof currentAdCallback === 'function') {
            console.log("Executing ad callback function.");
            try {
                currentAdCallback();
            } catch(e) {
                 console.error("Error executing ad callback:", e);
            }
            currentAdCallback = null;
        } else {
            console.warn("No callback function found after closing ad overlay.");
        }
    });
    // --- AD INTEGRATION END ---


    /***** Login/Signup Panel *****/
    document.getElementById("loginButton").addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            showInterstitialAd(() => {
                document.getElementById("loginPanel").style.display = "none";
                loadUserCoins();
                loadInviteCode(); // Load invite code after login
                showMainMenu();
                checkUrlForReferral(); // Check URL for referral after login
            });
        })
        .catch((error) => { alert("Login Error: " + error.message); });
    });

    document.getElementById("signupButton").addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          set(ref(db, "users/" + user.uid), {
            email: user.email,
            uid: user.uid,
            totalCoins: 0,
            referralCount: 0
            // inviteCode will be generated on first loadInviteCode call
          }).then(() => {
            showInterstitialAd(() => {
                document.getElementById("loginPanel").style.display = "none";
                loadUserCoins();
                loadInviteCode(); // Load/Generate invite code after signup
                showMainMenu();
                checkUrlForReferral(); // Check URL for referral after signup
            });
          });
        })
        .catch((error) => { alert("Sign Up Error: " + error.message); });
    });

    document.getElementById("guestButton").addEventListener("click", () => {
        document.getElementById("loginPanel").style.display = "none";
        loadUserCoins();
        showMainMenu();
        checkUrlForReferral(); // Check URL for referral even for guest (won't prefill if not logged in)
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadUserCoins();
        loadInviteCode();
         if (document.getElementById("loginPanel").style.display === 'none') {
            showMainMenu();
            checkUrlForReferral(); // Check URL if user is already logged in on page load
         }
      } else {
          document.getElementById("loginPanel").style.display = "flex";
          document.getElementById("mainMenu").style.display = "none";
          document.getElementById("gameCanvas").style.display = 'none';
          document.getElementById("menuCoinCount").innerText = "0";
          updateInviteButtonText(0);
      }
    });

    let totalCoins = 0;
    function loadUserCoins() {
      const user = auth.currentUser;
      if (user) {
        const userRef = ref(db, "users/" + user.uid + "/totalCoins");
        get(userRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              totalCoins = snapshot.val();
            } else {
              totalCoins = 0;
               set(userRef, 0);
            }
             document.getElementById("menuCoinCount").innerText = totalCoins;
             if (document.getElementById("gameOverMenu").style.display === 'flex') {
                 document.getElementById("finalTotalCoins").innerText = totalCoins;
             }
          })
          .catch((error) => {
              console.error("Error loading coins:", error);
              totalCoins = 0;
              document.getElementById("menuCoinCount").innerText = totalCoins;
           });
      } else {
        totalCoins = 0;
        document.getElementById("menuCoinCount").innerText = totalCoins;
      }
    }

    /***** Sound Settings *****/
    let soundEnabled = true;
    const backgroundAudio = document.getElementById("backgroundAudio");
    backgroundAudio.volume = 0.3;
    function playBackgroundMusic() {
        if (soundEnabled) {
            backgroundAudio.play().catch(error => {
                console.log("Background audio playback prevented:", error);
                soundEnabled = false;
                document.getElementById("toggleSound").textContent = "Sound: Off";
            });
        }
    }

    /***** Settings Modal Logic *****/
    document.getElementById("settingsBtn").addEventListener("click", () => {
      document.getElementById("settingsModal").style.display = "block";
    });
    document.getElementById("closeSettings").addEventListener("click", () => {
      document.getElementById("settingsModal").style.display = "none";
    });
    document.getElementById("toggleSound").addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      if (soundEnabled) {
        document.getElementById("toggleSound").textContent = "Sound: On";
        if (gameStarted) {
             playBackgroundMusic();
        }
      } else {
        document.getElementById("toggleSound").textContent = "Sound: Off";
        backgroundAudio.pause();
      }
    });
    document.getElementById("customerService").addEventListener("click", () => {
      window.open("https://wa.me/923019022815", "_blank");
    });

    /***** Invite Friend Logic *****/
    let currentUserInviteCode = null; // Store the user's code
    const baseInviteUrl = "https://luckyslot999.github.io/Super-mario-Running-/"; // Your game URL

    function generateRandomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function loadInviteCode() {
      const user = auth.currentUser;
      if (user) {
        const userRef = ref(db, "users/" + user.uid);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (!data.inviteCode) {
              const newCode = generateRandomCode();
              set(ref(db, "users/" + user.uid + "/inviteCode"), newCode)
                .then(() => {
                    currentUserInviteCode = newCode; // Store the new code
                    document.getElementById("yourInviteCode").textContent = newCode;
                }).catch(e => {
                    console.error("Failed to set invite code:", e);
                    document.getElementById("yourInviteCode").textContent = "Error";
                    currentUserInviteCode = null;
                });
            } else {
              currentUserInviteCode = data.inviteCode; // Store the existing code
              document.getElementById("yourInviteCode").textContent = data.inviteCode;
            }
          } else {
              console.log("User data node not found for invite code loading.");
              document.getElementById("yourInviteCode").textContent = "Error";
              currentUserInviteCode = null;
          }
          loadReferralCount();
        }).catch(e => {
            console.error("Failed to get user data for invite code:", e);
            document.getElementById("yourInviteCode").textContent = "Error";
            currentUserInviteCode = null;
        });
      } else {
        document.getElementById("yourInviteCode").textContent = "N/A (Guest)";
        currentUserInviteCode = null;
      }
    }

    // --- NEW: Function to check URL for referral code ---
    function checkUrlForReferral() {
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        const user = auth.currentUser; // Only prefill if logged in

        if (refCode && user) {
            const redeemInput = document.getElementById("redeemCodeInput");
            if (redeemInput) {
                redeemInput.value = refCode.trim().toUpperCase();
                console.log("Referral code found in URL and pre-filled:", refCode);

                // Optional: Clear the ref parameter from URL to avoid re-triggering on refresh
                // Uncomment the following lines if you want this behavior
                // const nextURL = window.location.pathname; // Get path without query string
                // window.history.replaceState({}, document.title, nextURL);

            } else {
                console.log("Referral code found, but redeem input field not available yet.");
            }
        } else if (refCode && !user) {
             console.log("Referral code found in URL, but user is not logged in. Will not pre-fill.");
        }
    }
    // --- End of new function ---


    function loadReferralCount() {
      const user = auth.currentUser;
      if (user) {
        get(ref(db, "users/" + user.uid + "/referralCount")).then((snap) => {
          let count = snap.exists() ? snap.val() : 0;
          updateInviteButtonText(count);
        }).catch(e => console.error("Failed to load referral count:", e));
      } else {
          updateInviteButtonText(0);
      }
    }
    function updateInviteButtonText(count) {
      document.getElementById("inviteFriend").innerText = "Invite Friend (" + (count || 0) + ")";
    }
    function redeemInviteCode(code) {
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to redeem an invite code.");
        return;
      }
      get(ref(db, "users/" + user.uid + "/referralRedeemed")).then((redeemedSnap) => {
        if (redeemedSnap.exists() && redeemedSnap.val() === true) {
          alert("You have already redeemed a referral code.");
          return;
        }
        const inviteQuery = query(ref(db, "users"), orderByChild("inviteCode"), equalTo(code));
        get(inviteQuery).then((snapshot) => {
          if (!snapshot.exists()) {
            alert("Invalid invite code.");
            return;
          }
          let referrerId = null;
          let referrerData = null;
          snapshot.forEach(childSnapshot => {
            if(childSnapshot.key !== user.uid) {
                referrerId = childSnapshot.key;
                referrerData = childSnapshot.val();
            }
          });
          if (!referrerId) {
            alert("Invalid invite code or you cannot redeem your own code.");
            return;
          }
          let currentReferralCount = referrerData.referralCount || 0;
          if (currentReferralCount >= 10) {
            alert("This referral code has reached its maximum usage (10 users).");
            return;
          }
          let redeemerCoins = totalCoins + 200;
          set(ref(db, "users/" + user.uid + "/totalCoins"), redeemerCoins).then(() => {
              totalCoins = redeemerCoins;
              document.getElementById("menuCoinCount").innerText = totalCoins;
              let referrerCoins = (referrerData.totalCoins || 0) + 100;
              set(ref(db, "users/" + referrerId + "/totalCoins"), referrerCoins);
              set(ref(db, "users/" + user.uid + "/referralRedeemed"), true);
              let newReferralCount = currentReferralCount + 1;
              set(ref(db, "users/" + referrerId + "/referralCount"), newReferralCount);
              loadReferralCount();
              alert("Invite code redeemed successfully! You got 200 coins. The referrer got 100 coins.");
              document.getElementById("inviteModal").style.display = "none";
              document.getElementById("redeemCodeInput").value = "";
          }).catch(error => {
              alert("Error updating your coins: " + error.message);
          });
        }).catch((error) => {
          console.error("Error querying for invite code: ", error);
          alert("Error redeeming code: " + error.message);
        });
      }).catch(error => {
        alert("Error checking your referral status: " + error.message);
      });
    }

    document.getElementById("inviteFriend").addEventListener("click", () => {
      if (!auth.currentUser) {
          alert("Please log in to use the invite feature.");
          return;
      }
      document.getElementById("inviteModal").style.display = "block";
      // loadInviteCode(); // Already called on login/auth state change, but call again to be sure data is fresh
    });

    document.getElementById("closeInviteModal").addEventListener("click", () => {
      document.getElementById("inviteModal").style.display = "none";
    });

    // UPDATED: Copy Link Listener
    document.getElementById("copyInviteCode").addEventListener("click", () => {
       if (currentUserInviteCode && currentUserInviteCode !== "Loading..." && currentUserInviteCode !== "N/A (Guest)" && currentUserInviteCode !== "Error") {
            const inviteLink = `${baseInviteUrl}?ref=${currentUserInviteCode}`; // Construct the full link
            navigator.clipboard.writeText(inviteLink).then(() => {
                alert("Invite link copied to clipboard!"); // Updated alert message
            }).catch(err => {
                alert("Failed to copy link. Please copy it manually.");
                console.error('Clipboard copy failed: ', err);
            });
       } else {
           alert("Invite code/link not available to copy. Please ensure you are logged in.");
       }
    });

    document.getElementById("redeemCodeBtn").addEventListener("click", () => {
      const codeInput = document.getElementById("redeemCodeInput");
      const code = codeInput.value.trim().toUpperCase();
      if (code === "") {
        alert("Please enter an invite code.");
        return;
      }
      redeemInviteCode(code);
    });
    // (End of Invite Logic Section)

    /***** Game Code *****/
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        const bannerHeight = document.getElementById('bannerAdContainer')?.offsetHeight || 90; // Use optional chaining
        canvas.height = window.innerHeight - bannerHeight;
        if (mario) {
             const groundY = canvas.height - 50;
             if (mario.y + mario.height > groundY || !mario.isJumping) {
                 mario.y = groundY - mario.height;
             }
        }
    }
    window.addEventListener("resize", resizeCanvas);

    let gameStarted = false;
    let mario, obstacles, coins, speed, score, gameOver;
    let bgX = 0;
    let platformX = 0;

    // --- Double Jump Variables ---
    let lastJumpInputTime = 0;
    const doubleJumpWindow = 300; // milliseconds allowed between jumps for a double jump
    let canDoubleJump = false;
    // --- End Double Jump Variables ---

    // Preload images
    const characterImg = new Image();
    characterImg.src = "https://i.imgur.com/AbfH2aB.png";
    const backgroundImg = new Image();
    backgroundImg.src = "https://i.imgur.com/xZpZqGt.png";
    const enemyImg = new Image();
    enemyImg.src = "https://i.imgur.com/TsR4WXH.png";
    const coinImg = new Image();
    coinImg.src = "https://i.imgur.com/cMQ9X0d.png";
    const platformImg = new Image();
    platformImg.src = "https://i.imgur.com/06ptzal.png";

    let imagesLoaded = 0;
    const totalImages = 5;
    function imageLoaded() {
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
            console.log("All game images loaded.");
        }
    }
    [characterImg, backgroundImg, enemyImg, coinImg, platformImg].forEach(img => {
        img.onload = imageLoaded;
        img.onerror = () => console.error("Failed to load image:", img.src);
    });

    function init() {
      resizeCanvas();
      bgX = 0;
      platformX = 0;
      const groundY = canvas.height - 50;
      mario = {
        x: 50,
        y: groundY - 60,
        width: 40,
        height: 60,
        dy: 0,
        gravity: 1.5,
        jumpPower: -20, // Initial jump power
        doubleJumpPower: -24, // Slightly stronger for double jump
        isJumping: false
      };
      obstacles = [];
      coins = [];
      speed = 5;
      score = 0;
      gameOver = false;
      gameStarted = true;
      lastJumpInputTime = 0; // Reset jump timer
      canDoubleJump = false; // Reset double jump capability
      console.log("Game Initialized. Canvas H:", canvas.height, "Mario Y:", mario.y);
    }

    function drawBackground() {
      if (!backgroundImg.complete || backgroundImg.naturalWidth === 0) return;
      bgX -= speed * 0.5;
      if (bgX <= -canvas.width) { bgX = 0; }
      let offset = Math.floor(bgX);
      ctx.drawImage(backgroundImg, offset, 0, canvas.width, canvas.height);
      if (offset + canvas.width < canvas.width) {
         ctx.drawImage(backgroundImg, offset + canvas.width, 0, canvas.width, canvas.height);
      }
    }

    function drawPlatform() {
       if (!platformImg.complete || platformImg.naturalWidth === 0) return;
      platformX -= speed;
      if (platformX <= -canvas.width) { platformX = 0; }
      let pOffset = Math.floor(platformX);
      const groundY = canvas.height - 50;
      ctx.drawImage(platformImg, pOffset, groundY, canvas.width, 50);
       if (pOffset + canvas.width < canvas.width) {
          ctx.drawImage(platformImg, pOffset + canvas.width, groundY, canvas.width, 50);
       }
    }

    function drawMario() {
       if (!characterImg.complete || characterImg.naturalWidth === 0 || !mario) return;
       ctx.drawImage(characterImg, mario.x, mario.y, mario.width, mario.height);
    }

    function drawObstacles() {
      if (!enemyImg.complete || enemyImg.naturalWidth === 0) return;
      for (let i = obstacles.length - 1; i >= 0; i--) {
        let obstacle = obstacles[i];
        ctx.drawImage(enemyImg, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
        obstacle.x -= speed;
        if (obstacle.x + obstacle.width < 0) { obstacles.splice(i, 1); }
      }
    }

    function spawnCoins() {
      if (!coinImg.complete || coinImg.naturalWidth === 0) return;
      if (coins.length < 20 && Math.random() < 0.015) {
        const groundY = canvas.height - 70 - (Math.random() * 50);
        let clusterSize = Math.floor(Math.random() * 3) + 3;
        let startX = canvas.width + Math.random() * 50;
        for (let i = 0; i < clusterSize; i++) {
          coins.push({ x: startX + i * 40, y: groundY, width: 20, height: 20 });
        }
      }
    }

    function drawCoins() {
        if (!coinImg.complete || coinImg.naturalWidth === 0) return;
        const user = auth.currentUser;

        for (let i = coins.length - 1; i >= 0; i--) {
            let coin = coins[i];
            ctx.drawImage(coinImg, coin.x - coin.width / 2, coin.y - coin.height / 2, coin.width, coin.height);
            coin.x -= speed;

            if (mario &&
                mario.x < coin.x + coin.width / 2 &&
                mario.x + mario.width > coin.x - coin.width / 2 &&
                mario.y < coin.y + coin.height / 2 &&
                mario.y + mario.height > coin.y - coin.height / 2
            ) {
                coins.splice(i, 1);
                score += 1;
                if (user) {
                    totalCoins += 1;
                     document.getElementById("menuCoinCount").innerText = totalCoins;
                     document.getElementById("finalTotalCoins").innerText = totalCoins;
                }
            } else if (coin.x + coin.width < 0) {
                 coins.splice(i, 1);
            }
        }
    }


    function applyPhysics() {
        if (!mario) return;
        mario.dy += mario.gravity;
        mario.y += mario.dy;
        const groundY = canvas.height - 50;

        if (mario.y + mario.height >= groundY) {
            mario.y = groundY - mario.height;
            mario.dy = 0;
            mario.isJumping = false;
            canDoubleJump = false; // Reset double jump when landing
        }
        if (mario.y < 0) {
            mario.y = 0;
            mario.dy = 0;
        }
    }

    function spawnObstacles() {
      if (obstacles.length < 5 && Math.random() < 0.01) {
        const groundY = canvas.height - 50;
        obstacles.push({
            x: canvas.width,
            y: groundY - 50,
            width: 50,
            height: 50
        });
      }
    }

    function checkCollision() {
      if (!mario) return;
      for (let i = obstacles.length - 1; i >= 0; i--) {
        let obstacle = obstacles[i];
        if (
          mario.x < obstacle.x + obstacle.width &&
          mario.x + mario.width > obstacle.x &&
          mario.y < obstacle.y + obstacle.height &&
          mario.y + mario.height > obstacle.y
        ) {
            gameOver = true;
            console.log("Collision Detected!");
            break;
        }
      }
    }

    let animationFrameId = null;

    function gameLoop() {
        if (!gameStarted || gameOver) {
            if (gameOver) {
                handleGameOver();
            }
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground();
        drawPlatform();
        drawMario();
        drawObstacles();
        drawCoins();
        applyPhysics();
        spawnObstacles();
        spawnCoins();
        checkCollision();

        ctx.fillStyle = "#FFFFFF";
        ctx.font = "24px 'Press Start 2P', cursive";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText("Score: " + score, 20, 20);

        animationFrameId = requestAnimationFrame(gameLoop);
    }

    function handleGameOver() {
         console.log("Handling Game Over. Final Score:", score);
         gameStarted = false;
         const user = auth.currentUser;
         if (user && score > 0) {
             console.log("Attempting to save coins to Firebase. Current Total:", totalCoins);
             set(ref(db, "users/" + user.uid + "/totalCoins"), totalCoins)
                .then(() => console.log("Final coins saved to Firebase:", totalCoins))
                .catch(e => console.error("Error saving final coins:", e));
         } else if (!user) {
             console.log("Game Over for Guest. Score:", score);
         }
         if (soundEnabled) backgroundAudio.pause();
         showGameOverMenu();
    }

    // --- UPDATED JUMP FUNCTION with Double Jump ---
    function jump() {
        if (!gameStarted || !mario) return; // Guard conditions

        const currentTime = Date.now();
        const groundY = canvas.height - 50;
        const onGround = mario.y + mario.height >= groundY - 5; // Check if on or very near ground

        // Check for Double Jump first (must be in the air, within time window, and double jump available)
        if (mario.isJumping && canDoubleJump && (currentTime - lastJumpInputTime < doubleJumpWindow)) {
             console.log("Double Jump!");
             mario.dy = mario.doubleJumpPower; // Apply double jump strength
             canDoubleJump = false; // Consume the double jump
             lastJumpInputTime = 0; // Reset timer to prevent triple jump issues
        }
        // Check for First Jump (must be on the ground)
        else if (onGround) {
            console.log("First Jump!");
            mario.dy = mario.jumpPower; // Apply normal jump strength
            mario.isJumping = true;
            canDoubleJump = true; // Allow a double jump after this
            lastJumpInputTime = currentTime; // Record time of this jump input
        }
    }
    // --- End Updated Jump Function ---

    // Event Listeners for Jump
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" && gameStarted && !gameOver) {
          e.preventDefault();
          jump();
      }
    });
    // Use 'click' instead of 'touchstart' for broader compatibility and to register double-clicks easily
    canvas.addEventListener("click", (e) => {
         if (gameStarted && !gameOver) {
             e.preventDefault();
             jump();
         }
    });


    function showMainMenu() {
      gameStarted = false;
      gameOver = false;
      if(animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
      loadUserCoins();
      resizeCanvas();
      document.getElementById("mainMenu").style.display = "flex";
      document.getElementById("gameOverMenu").style.display = "none";
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("gameCanvas").style.display = 'none';
      if (soundEnabled) backgroundAudio.pause();
    }

    function showGameOverMenu() {
      document.getElementById("sessionCoinCount").innerText = score;
      document.getElementById("finalTotalCoins").innerText = totalCoins; // Ensure totalCoins is up-to-date here
      document.getElementById("gameOverMenu").style.display = "flex";
      document.getElementById("mainMenu").style.display = "none";
      document.getElementById("gameCanvas").style.display = 'block';
    }

    // --- Button Listeners for Ads ---
    document.getElementById("startBtn").addEventListener("click", () => {
        showInterstitialAd(() => {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("gameCanvas").style.display = 'block';
            init();
            if (soundEnabled) playBackgroundMusic();
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        });
    });

    document.getElementById("restartBtn").addEventListener("click", () => {
        showInterstitialAd(() => {
            document.getElementById("gameOverMenu").style.display = "none";
            document.getElementById("gameCanvas").style.display = 'block';
            init();
            if (soundEnabled) playBackgroundMusic();
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        });
    });

    document.getElementById("backMenuBtn").addEventListener("click", () => {
        showMainMenu();
    });

    /***** Redeem Modal Logic *****/
    document.getElementById("withdrawBtn").addEventListener("click", () => {
        if (!auth.currentUser) {
            alert("Please log in to withdraw coins.");
            return;
        }
        loadUserCoins();
        document.getElementById("withdrawModal").style.display = "block";
        document.getElementById("redeemForm").style.display = "none";
        document.getElementById("redeemOptions").style.display = "block";
        document.getElementById("redeemDetailsForm").reset();
    });
    document.getElementById("closeWithdraw").addEventListener("click", () => {
      document.getElementById("withdrawModal").style.display = "none";
    });
    let selectedCoins = 0;
    let selectedPKR = 0;
    const redeemOptionButtons = document.querySelectorAll('.redeem-option');
    redeemOptionButtons.forEach(button => {
      button.addEventListener('click', () => {
        selectedCoins = parseInt(button.getAttribute('data-coins'), 10);
        selectedPKR = parseInt(button.getAttribute('data-pkr'), 10);
        if (totalCoins < selectedCoins) {
            alert(`You need ${selectedCoins} coins to redeem ${selectedPKR} PKR. You currently have ${totalCoins} coins.`);
            return;
        }
        document.getElementById('redeemOptions').style.display = 'none';
        document.getElementById('redeemForm').style.display = 'block';
      });
    });
    document.getElementById('redeemDetailsForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const accountHolderNameInput = document.getElementById('accountHolderName');
      const accountNumberInput = document.getElementById('accountNumber');
      const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');
      const accountHolderName = accountHolderNameInput.value.trim();
      const accountNumber = accountNumberInput.value.trim();
      if (!accountHolderName || !accountNumber || !paymentMethodInput) {
           alert("Please fill in all fields and select a payment method.");
           return;
      }
       if (totalCoins < selectedCoins) {
            alert("You no longer have enough coins for this redemption.");
            document.getElementById('redeemForm').style.display = 'none';
            document.getElementById('redeemOptions').style.display = 'block';
            return;
       }
      const paymentMethod = paymentMethodInput.value;
      const user = auth.currentUser;
      if (!user) {
          alert("Authentication error. Please log in again.");
          return;
      }
      const withdrawalRequest = {
        uid: user.uid,
        email: user.email,
        withdrawalAmountCoins: selectedCoins,
        pkrAmount: selectedPKR,
        accountHolderName: accountHolderName,
        accountNumber: accountNumber,
        paymentMethod: paymentMethod,
        status: "pending",
        timestamp: Date.now()
      };
      const submitButton = document.getElementById('redeemSubmitBtn');
      submitButton.disabled = true;
      submitButton.textContent = "Submitting...";
      push(ref(db, "withdrawRequests"), withdrawalRequest)
        .then(() => {
          const newTotalCoins = totalCoins - selectedCoins;
          set(ref(db, "users/" + user.uid + "/totalCoins"), newTotalCoins)
            .then(() => {
                totalCoins = newTotalCoins;
                document.getElementById("menuCoinCount").innerText = totalCoins;
                alert(`Redemption request for ${selectedPKR} PKR submitted successfully! Your request is pending approval.`);
                document.getElementById("redeemDetailsForm").reset();
                document.getElementById("withdrawModal").style.display = "none";
            })
            .catch((error) => {
                alert("Request submitted, but failed to update your coin balance. Please contact support. Error: " + error.message);
                console.error("Error updating user coins after withdrawal:", error);
            })
            .finally(() => {
                 submitButton.disabled = false;
                 submitButton.textContent = "Submit";
            });
        })
        .catch((error) => {
            alert("Error submitting redemption request: " + error.message);
            console.error("Error pushing withdrawal request:", error);
             submitButton.disabled = false;
             submitButton.textContent = "Submit";
        });
    });


    /***** Info Modal Logic *****/
    document.getElementById("infoBtn").addEventListener("click", () => {
      document.getElementById("infoModal").style.display = "block";
    });
    document.getElementById("closeInfo").addEventListener("click", () => {
      document.getElementById("infoModal").style.display = "none";
    });

    /***** Logout Logic *****/
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
          console.log("User signed out.");
          totalCoins = 0;
          gameStarted = false;
          gameOver = false;
          if(animationFrameId) cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
          if(soundEnabled) backgroundAudio.pause();
          document.getElementById("mainMenu").style.display = "none";
          document.getElementById("gameOverMenu").style.display = "none";
          document.getElementById("loginPanel").style.display = "flex";
          document.getElementById("gameCanvas").style.display = 'none';
          document.getElementById("menuCoinCount").innerText = "0";
          updateInviteButtonText(0);
          document.getElementById("yourInviteCode").textContent = "N/A (Guest)";
          currentUserInviteCode = null; // Clear stored invite code on logout

      })
      .catch((error) => {
          alert("Logout error: " + error.message);
          console.error("Logout error: ", error);
       });
    });

    // Initial setup
    document.getElementById("loginPanel").style.display = "flex";
    document.getElementById("mainMenu").style.display = "none";
    document.getElementById("gameCanvas").style.display = "none";
    document.getElementById("gameOverMenu").style.display = "none";
    // checkUrlForReferral(); // Call initially - moved to after login/auth state change

  </script>
</body>
</html>