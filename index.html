<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mario Run â€“ Ultimate Gamer Edition</title>
  <!-- Import Google Font for a retro gaming feel -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- --- AD INTEGRATION START --- -->
  <!-- Social Bar Ad Script (Existing) -->
  <script type='text/javascript' src='//pl26412649.profitableratecpm.com/13/e5/a4/13e5a43804eecf191c995f63cff90d9c.js'></script>
  <!-- --- AD INTEGRATION END --- -->
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', cursive; /* Primary font for retro feel */
      overflow: hidden;
      background: #0a0a0a url('https://www.transparenttextures.com/patterns/stardust.png'); /* Subtle starry background */
      color: #fff;
      /* UPDATED: Reserve space for the NEW bottom banner height */
      margin-bottom: 50px;
    }

    canvas { display: block; /* margin: 0 auto; /* Center canvas if needed */ }

    /* ---------- Enhanced Visual Styling ---------- */
    /* Add a subtle glow/shadow to make elements pop */
    .text-glow { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff007f; }
    .box-glow { box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 15px rgba(255, 0, 127, 0.5); }

    /* Common button style - More vibrant and game-like */
    .game-btn {
      padding: 12px 25px;
      margin: 10px;
      font-size: 14px; /* Adjusted for Press Start 2P readability */
      border: none; /* Remove default border */
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background: linear-gradient(145deg, #ff4757, #ff6348); /* Vibrant red/orange */
      color: #fff;
      font-family: 'Press Start 2P', cursive;
      text-transform: uppercase;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      border-bottom: 4px solid #c0392b; /* 3D effect */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .game-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 100, 0.6);
      background: linear-gradient(145deg, #ff6348, #ff7f50); /* Lighter on hover */
    }

    .game-btn:active {
        transform: translateY(1px) scale(1);
        border-bottom-width: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* ---------- Login Panel ---------- */
    #loginPanel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/nxRZ03R.png') no-repeat center center;
      background-size: cover; z-index: 100;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
      background-color: rgba(0,0,0,0.5); /* Darken background image slightly */
    }
    #loginPanel h2 {
      font-size: 2.5em; color: #ff007f; /* Brighter Pink */
      margin-bottom: 30px;
      text-shadow: 3px 3px 0px #000, 0 0 15px #ff007f; /* Stronger shadow + glow */
    }
    #loginPanel input {
      width: 250px; padding: 12px 15px; margin: 8px;
      background: rgba(10, 10, 10, 0.8);
      border: 2px solid #ff007f; color: #fff;
      border-radius: 5px;
      font-family: 'Press Start 2P', cursive; font-size: 14px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
     #loginPanel input:focus {
        border-color: #ff60af;
        box-shadow: 0 0 10px rgba(255, 0, 127, 0.7);
     }
    #loginPanel button {
      /* Use the common button style */
      width: 180px;
      /* Inherit base styles from .game-btn, override gradient */
      background: linear-gradient(145deg, #ff007f, #e60073);
      border-bottom-color: #a70057;
    }
    #loginPanel button:hover {
        background: linear-gradient(145deg, #e60073, #ff309f);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 0, 127, 0.6);
    }

    /* ---------- Main Menu ---------- */
    #mainMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://i.imgur.com/KFWJlte.png') no-repeat center center;
      background-size: cover; z-index: 30;
      display: none; /* Initially hidden */
      flex-direction: column; justify-content: center; align-items: center;
      color: #fff; padding: 20px; text-align: center;
    }
    #mainMenu h1 {
      font-size: 3.5em; /* Larger Title */
      text-shadow: 4px 4px 0px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.5); /* More prominent shadow */
      margin-bottom: 40px;
      color: #ffe64d; /* Gold color */
    }
    /* Top right coin status with coin icon */
    #topRightStatus {
      position: absolute; top: 15px; right: 15px;
      background: rgba(0,0,0,0.85); padding: 12px 18px; border-radius: 8px;
      font-size: 18px; /* Slightly smaller font for Press Start 2P */
      color: #FFD700; /* Gold text */
      z-index: 35;
      border: 2px solid #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    #topRightStatus svg {
      width: 24px; height: 24px; vertical-align: middle;
      fill: #FFD700; margin-right: 8px;
    }
    /* Settings button using a professional gear icon */
    #settingsBtn {
      position: absolute; top: 15px; left: 15px;
      background: rgba(0,0,0,0.8); border: 2px solid #ccc; border-radius: 50%;
      cursor: pointer; z-index: 35;
      width: 45px; height: 45px;
      display: flex; justify-content: center; align-items: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #settingsBtn svg {
      width: 24px; height: 24px; fill: #fff;
    }
    #settingsBtn:hover {
        transform: rotate(45deg) scale(1.1);
        box-shadow: 0 0 15px rgba(255,255,255,0.7);
        border-color: #fff;
    }
    /* Use common button style for menu buttons */
    #mainMenu .menu-btn {
      /* Inherit from .game-btn */
      width: 220px; /* Consistent width */
    }
    #mainMenu #withdrawBtn {
        background: linear-gradient(145deg, #2ed573, #1dd1a1); /* Green gradient */
        border-bottom-color: #10ac84;
    }
     #mainMenu #withdrawBtn:hover {
        background: linear-gradient(145deg, #1dd1a1, #00b894);
         box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(46, 213, 115, 0.6);
    }
     #mainMenu #inviteFriend {
        background: linear-gradient(145deg, #54a0ff, #2e86de); /* Blue gradient */
        border-bottom-color: #1e5ea8;
    }
     #mainMenu #inviteFriend:hover {
        background: linear-gradient(145deg, #2e86de, #1e66b0);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(84, 160, 255, 0.6);
    }
     #mainMenu #logoutBtn {
        background: linear-gradient(145deg, #8395a7, #576574); /* Grey gradient */
        border-bottom-color: #2f3640;
    }
    #mainMenu #logoutBtn:hover {
        background: linear-gradient(145deg, #576574, #434c58);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(131, 149, 167, 0.6);
    }

    /* ---------- Game Over Overlay ---------- */
    #gameOverMenu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); /* Darker overlay */
      z-index: 40;
      display: none; /* Initially hidden */
      flex-direction: column; justify-content: center; align-items: center;
      color: #ff4757; /* Red for game over */
      padding: 20px; text-align: center;
    }
    #gameOverMenu h2 {
      font-size: 4em; /* Much larger */
      text-shadow: 4px 4px 0px #000, 0 0 20px #ff0000; /* Strong red glow */
      margin-bottom: 20px;
    }
    #gameOverMenu p {
        font-size: 1.5em; /* Larger score text */
        color: #fff;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px #000;
    }
    #gameOverMenu .menu-btn {
      /* Use common style, maybe specific colors */
      width: 200px;
    }
    #gameOverMenu #restartBtn {
        background: linear-gradient(145deg, #2ed573, #1dd1a1); /* Green */
        border-bottom-color: #10ac84;
    }
    #gameOverMenu #backMenuBtn {
        background: linear-gradient(145deg, #54a0ff, #2e86de); /* Blue */
        border-bottom-color: #1e5ea8;
    }

    /* ---------- Modals General Styling ---------- */
    .modal {
        display: none; position: fixed; z-index: 70;
        left: 0; top: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); /* Semi-transparent dark */
        backdrop-filter: blur(5px); /* Optional blur effect */
    }
    .modal .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #1e1e1e; /* Dark grey */
      padding: 25px 30px;
      border-radius: 10px;
      width: 90%; max-width: 400px; /* Adjusted max-width */
      color: #eee;
      text-align: center;
      font-family: 'Press Start 2P', cursive;
      border: 3px solid #ff007f; /* Pink border */
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 127, 0.4); /* Outer shadow + glow */
    }
    .modal h2 {
        margin-bottom: 20px;
        font-size: 1.5em; /* Consistent modal title size */
        color: #ff007f; /* Match border color */
        text-shadow: 1px 1px 2px #000;
    }
    .modal button.game-btn { /* Apply game button style within modals */
         width: 100%;
         margin: 8px 0; /* Adjust margin for vertical layout */
         padding: 10px 15px; /* Slightly smaller padding */
         font-size: 12px;
    }
    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="password"] {
        width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px;
        border: 2px solid #555; border-radius: 5px;
        background: #333; color: #fff;
        font-family: 'Arial', sans-serif; /* Use Arial for input readability */
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .modal input:focus {
        border-color: #ff007f;
        box-shadow: 0 0 8px rgba(255, 0, 127, 0.6);
    }
    .close-btn {
      position: absolute; top: 10px; right: 15px;
      background: none; border: none; font-size: 28px; cursor: pointer;
      color: #aaa; font-family: Arial, sans-serif; /* Use a standard font for 'X' */
      transition: color 0.2s, transform 0.2s;
      font-weight: bold;
    }
    .close-btn:hover {
      color: #ff007f;
      transform: scale(1.2);
    }

    /* ---------- Settings Modal Specifics ---------- */
    #settingsModal .modal-content { max-width: 320px; }
    #toggleSound { /* Use game-btn base */ background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #customerService { /* Use game-btn base */ background: linear-gradient(145deg, #54a0ff, #2e86de); border-bottom-color: #1e5ea8; }
    #toggleSound:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }
    #customerService:hover { background: linear-gradient(145deg, #2e86de, #1e66b0); }


    /* ---------- Invite Modal Specifics ---------- */
    #inviteModal .modal-content { max-width: 380px; }
    #inviteModal .section { margin: 20px 0; border-top: 1px solid #444; padding-top: 15px; }
    #inviteModal .section h3 { font-size: 1.1em; margin-bottom: 10px; color: #eee; }
    #inviteModal .section p { font-size: 1em; margin-bottom: 12px; font-family: Arial, sans-serif; } /* Readable text */
    #yourInviteCode {
        font-size: 1.2em;
        color: #FFD700; /* Gold color for the code */
        background: #333;
        padding: 8px 12px;
        border-radius: 5px;
        display: inline-block;
        border: 1px solid #555;
    }
    #copyInviteCode { /* Use game-btn base */ background: linear-gradient(145deg, #feca57, #ff9f43); border-bottom-color: #e67e22; }
    #redeemCodeBtn { /* Use game-btn base */ background: linear-gradient(145deg, #2ed573, #1dd1a1); border-bottom-color: #10ac84; }
    #copyInviteCode:hover { background: linear-gradient(145deg, #ff9f43, #f39c12); }
    #redeemCodeBtn:hover { background: linear-gradient(145deg, #1dd1a1, #00b894); }

    /* ---------- Withdraw Modal Specifics ---------- */
    #withdrawModal .modal-content { max-width: 420px; }
    #withdrawModal .modal-content p { margin-bottom: 20px; font-family: Arial, sans-serif; line-height: 1.5; }
    #withdrawModal .redeem-option {
      /* Use game-btn base */
      background: linear-gradient(145deg, #2ed573, #1dd1a1);
      border-bottom-color: #10ac84;
      width: 100%;
      margin: 5px 0;
      font-size: 12px; /* Slightly smaller font */
    }
     #withdrawModal .redeem-option:hover {
        background: linear-gradient(145deg, #1dd1a1, #00b894);
     }
    #redeemForm {
      display: none; margin-top: 20px;
      font-family: Arial, sans-serif; /* Use Arial for form readability */
      font-size: 16px; line-height: 1.5; text-align: left;
    }
    #redeemForm h3 {
      font-family: 'Press Start 2P', cursive; /* Use game font for sub-heading */
      font-size: 1.2em; color: #eee;
      margin-bottom: 15px; text-align: center;
    }
    #redeemForm label { display: block; margin-bottom: 5px; color: #ccc; font-size: 14px; }
    #redeemForm input[type="text"] { /* Already styled by modal input styles */ margin-bottom: 15px; }
    #redeemForm input[type="radio"] { margin-right: 8px; vertical-align: middle; }
    #redeemForm label input[type="radio"] { display: inline; margin-bottom: 0; } /* Adjust radio button layout */
    #redeemForm .payment-options label { margin-bottom: 10px; display: block;}
    #redeemSubmitBtn {
        /* Use game-btn base */
        background: linear-gradient(145deg, #2ed573, #1dd1a1);
        border-bottom-color: #10ac84;
        width: 100%; margin-top: 20px; font-size: 14px;
    }
     #redeemSubmitBtn:hover {
        background: linear-gradient(145deg, #1dd1a1, #00b894);
     }
    #redeemSubmitBtn:disabled {
        background: #555;
        cursor: not-allowed;
        border-bottom-color: #333;
    }

    /* ---------- Game Info Modal Specifics ---------- */
    #infoModal .modal-content { max-width: 400px; }
    #infoModal .modal-content h2 { color: #54a0ff; /* Blue title */ } /* Override pink */
    #infoModal .modal-content p {
      margin: 15px 0; font-family: Arial, sans-serif; font-size: 15px; line-height: 1.6;
      color: #ddd; text-align: left;
    }
    #infoModal .modal-content p strong { color: #fff; }


    /* --- AD INTEGRATION STYLING --- */
    /* Banner Ad Container Styling */
    #bannerAdContainer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        /* UPDATED: Height for the NEW ad script */
        height: 50px;
        background-color: #000; /* Black background */
        z-index: 1000; /* Ensure it's above most elements */
        display: flex;
        justify-content: center; /* Center the ad iframe */
        align-items: center;
        overflow: hidden; /* Prevent ad content from spilling */
        border-top: 2px solid #333; /* Subtle separator */
    }

    /* Interstitial Ad Overlay Styling */
    #interstitialAdOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9); /* Darker overlay */
        z-index: 2000; /* Above everything else */
        display: none; /* Hidden by default */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        font-family: 'Press Start 2P', cursive;
        padding: 20px; /* Add padding */
        backdrop-filter: blur(3px);
    }
    #interstitialAdOverlay p#adInfoText { /* Specific ID for text */
        font-size: 1.1em; /* Adjusted size */
        margin-bottom: 25px;
        color: #eee;
        line-height: 1.5;
    }
    #interstitialAdCloseButton {
        /* Use game-btn styling */
        padding: 12px 25px;
        font-size: 1em;
        cursor: pointer;
        background: linear-gradient(145deg, #ff4757, #e84118); /* Red gradient */
        border-bottom-color: #c23616;
        color: white;
        border-radius: 8px;
        font-family: 'Press Start 2P', cursive;
        display: none; /* Hidden until timer finishes */
        text-transform: uppercase;
        margin-top: 20px; /* Space above button */
    }
    #interstitialAdCloseButton:hover {
        background: linear-gradient(145deg, #e84118, #d63031);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 71, 87, 0.6);
    }
    #interstitialAdTimer {
        margin-top: 15px;
        font-size: 0.9em;
        color: #ccc; /* Lighter color for timer */
    }
     #interstitialAdOverlay p.skip-info {
        font-size: 0.8em;
        color: #aaa;
        margin-top: 30px;
        font-family: Arial, sans-serif;
        line-height: 1.4;
     }
    /* --- AD INTEGRATION END --- */

  </style>
</head>
<body>
  <!-- Hidden audio element for background music -->
  <audio id="backgroundAudio" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/06/21/audio_94dbe2d091.mp3?filename=beats-2-cherry-cute-bgm-271158.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- ---------- Login Panel ---------- -->
  <div id="loginPanel">
    <h2>Gamer Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginButton" class="game-btn">Login</button>
    <button id="signupButton" class="game-btn">Sign Up</button>
    <button id="guestButton" class="game-btn">Continue Guest</button>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- ---------- Main Menu ---------- -->
  <div id="mainMenu"> <!-- style="display: flex;" controlled by JS -->
    <!-- Settings button at top left -->
    <button id="settingsBtn" title="Open Settings">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
        <path d="M487.4 315.7l-42.1-24.3c2.8-12.8 4.3-26 4.3-39.4s-1.5-26.6-4.3-39.4l42.1-24.3c9.4-5.4 13.3-17.1 9.4-27.2l-45.3-78.4c-3.9-10.1-14.2-14.8-24.7-11.5l-49.5 19.9c-20.5-16.1-43-29.2-67.2-38.1l-7.5-52.8C309 3.7 300.3-2.5 290.3.1l-90.6 18.5c-10 2.1-17.6 9.9-19.8 19.8l-7.5 52.8c-24.3 8.9-46.8 22-67.2 38.1L54.6 83.1c-10.5-3.3-20.8.4-24.7 11.5L-15.4 172.9c-3.9 10.1-.1 21.8 9.4 27.2l42.1 24.3C73.5 243.3 72 256.4 72 269.9c0 13.5 1.5 26.6 4.3 39.4l-42.1 24.3c-9.4 5.4-13.3 17.1-9.4 27.2l45.3 78.4c3.9 10.1 14.2 14.8 24.7 11.5l49.5-19.9c20.5 16.1 43 29.2 67.2 38.1l7.5 52.8c2 10 10.7 15.3 20.7 12.8l90.6-18.5c10-2.1 17.6-9.9 19.8-19.8l7.5-52.8c24.3-8.9 46.8-22 67.2-38.1l49.5 19.9c10.5 3.3 20.8-.4 24.7-11.5l45.3-78.4c3.9-10.1.1-21.8-9.4-27.2zM256 336c-44.2 0-80-35.8-80-80s35.8-80 80-80c44.2 0 80 35.8 80 80s-35.8 80-80 80z"></path>
      </svg>
    </button>
    <!-- Top right coin status with coin icon -->
    <div id="topRightStatus">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. --><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256S114.6 512 256 512s256-114.6 256-256zM188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9V344c0 8.6 4.7 16.7 12.3 20.9s16.8 3.1 23.7-1.7l176-104c7.1-4.2 11.2-11.8 11.2-19.8s-4.1-15.6-11.2-19.8l-176-104c-6.9-4.8-16.1-5.9-23.7-1.7z"/></svg>
      Coins: <span id="menuCoinCount">0</span>
    </div>
    <h1>Mario Run</h1>
    <button id="startBtn" class="menu-btn game-btn">Play Now</button>
    <button id="withdrawBtn" class="menu-btn game-btn">Withdraw Coins</button>
    <button id="inviteFriend" class="menu-btn game-btn">Invite Friend</button> <!-- Text updated by JS -->
    <button id="infoBtn" class="menu-btn game-btn">Game Info</button>
    <button id="logoutBtn" class="menu-btn game-btn">Exit Game</button>
  </div>

  <!-- ---------- Settings Modal ---------- -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeSettings">Ã—</button>
      <h2>Settings</h2>
      <button id="toggleSound" class="game-btn">Sound: On</button>
      <button id="customerService" class="game-btn">Customer Service</button>
    </div>
  </div>

  <!-- ---------- Invite Modal ---------- -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInviteModal">Ã—</button>
      <h2>Invite Friend</h2>
      <div class="section">
        <h3>Your Invite Link</h3>
        <p id="yourInviteCode">Loading...</p> <!-- Will display the code, but copied as link -->
        <button id="copyInviteCode" class="game-btn">Copy Link</button>
      </div>
      <div class="section">
        <h3>Redeem Invite Code</h3>
        <input type="text" id="redeemCodeInput" placeholder="Enter friend's code" />
        <button id="redeemCodeBtn" class="game-btn">Redeem</button>
      </div>
    </div>
  </div>

  <!-- ---------- Game Over Overlay ---------- -->
  <div id="gameOverMenu">
    <h2>Game Over</h2>
    <p>Session Coins: <span id="sessionCoinCount">0</span></p>
    <p>Total Coins: <span id="finalTotalCoins">0</span></p>
    <button id="restartBtn" class="menu-btn game-btn">Restart</button>
    <button id="backMenuBtn" class="menu-btn game-btn">Back to Menu</button>
  </div>

  <!-- ---------- Withdraw Modal ---------- -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeWithdraw">Ã—</button>
      <h2>Redeem Coins</h2>
      <p>Select an option to redeem your coins:</p>
      <div id="redeemOptions">
        <!-- Buttons now use game-btn class implicitly via modal styles -->
        <button class="redeem-option" data-coins="10000" data-pkr="100">10000 Coins - 100PKR</button>
        <button class="redeem-option" data-coins="30000" data-pkr="300">30000 Coins - 300PKR</button>
        <button class="redeem-option" data-coins="50000" data-pkr="500">50000 Coins - 500PKR</button>
        <button class="redeem-option" data-coins="80000" data-pkr="800">80,000 Coins - 800PKR</button>
        <button class="redeem-option" data-coins="100000" data-pkr="1000">100,000 Coins - 1000PKR</button>
        <button class="redeem-option" data-coins="500000" data-pkr="5000">500,000 Coins - 5000PKR</button>
      </div>
      <div id="redeemForm">
        <h3>Enter Your Details</h3>
        <form id="redeemDetailsForm">
          <div>
            <label for="accountHolderName">Account Holder Name:</label>
            <input type="text" id="accountHolderName" required />
          </div>
          <div>
            <label for="accountNumber">Account Number:</label>
            <input type="text" id="accountNumber" required />
          </div>
          <div class="payment-options">
            <label for="paymentMethod">Select Payment Method:</label>
            <label><input type="radio" name="paymentMethod" value="JazzCash" required> JazzCash</label>
            <label><input type="radio" name="paymentMethod" value="EasyPaisa" required> EasyPaisa</label>
          </div>
          <button type="submit" id="redeemSubmitBtn" class="game-btn">Submit Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ---------- Game Info Modal ---------- -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeInfo">Ã—</button>
      <h2>Game Info</h2>
      <p>
        Welcome to <strong>Mario Run â€“ Ultimate Gamer Edition</strong>. Enjoy endless fun and earn coins while you play!
      </p>
      <p>
        <strong>Online Play:</strong> Log in or sign up to save your coins. Earned coins can be redeemed for rewards!
      </p>
      <p>
        <strong>Offline Play (Guest):</strong> Play for fun! Coins earned as a guest are not saved and cannot be redeemed.
      </p>
        <p>
        <strong>Invite Friends:</strong> Share your invite link. You and your friend both earn bonus coins when they redeem your code!
      </p>
    </div>
  </div>

  <!-- --- AD INTEGRATION START --- -->
  <!-- Banner Ad Container -->
  <div id="bannerAdContainer">
      <!-- NEW Banner ad script provided -->
      <script type="text/javascript">
          atOptions = {
              'key' : '84c9a4eabdeffe242051226bdf854fd8',
              'format' : 'iframe',
              'height' : 50,
              'width' : 320,
              'params' : {}
          };
      </script>
      <script type="text/javascript" src="//www.highperformanceformat.com/84c9a4eabdeffe242051226bdf854fd8/invoke.js"></script>
      <!-- OLD Banner ad script removed -->
  </div>

  <!-- Interstitial Ad Overlay -->
  <div id="interstitialAdOverlay">
      <p id="adInfoText">Advertisement loading in a new tab...</p>
      <div id="interstitialAdTimer"></div>
      <button id="interstitialAdCloseButton" class="game-btn">Skip Ad</button> <!-- Styled as game button -->
       <p class="skip-info">(Click 'Skip Ad' to return to the game. You may need to close the ad tab manually afterwards.)</p>
  </div>
  <!-- --- AD INTEGRATION END --- -->


  <!-- Firebase and Game Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, push, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

    const firebaseConfig = {
      // Keep your existing Firebase config
      apiKey: "AIzaSyCxqQEPU7qpEGleQXok7OFAyAouOrccoUY", // WARNING: Consider securing this key
      authDomain: "test1-f9ef8.firebaseapp.com",
      databaseURL: "https://test1-f9ef8-default-rtdb.firebaseio.com",
      projectId: "test1-f9ef8",
      storageBucket: "test1-f9ef8.appspot.com",
      messagingSenderId: "709839711061",
      appId: "1:709839711061:web:ae8cc321d2ddac66c91ddc",
      measurementId: "G-K4Q94MBQDT"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const db = getDatabase(appFirebase);
    const auth = getAuth();

    // --- AD INTEGRATION START ---
    const interstitialAdOverlay = document.getElementById('interstitialAdOverlay');
    const interstitialAdCloseButton = document.getElementById('interstitialAdCloseButton');
    const interstitialAdTimer = document.getElementById('interstitialAdTimer');
    const adInfoText = document.getElementById('adInfoText');
    const directLinkUrl = "https://www.profitableratecpm.com/ycus2u5z?key=6d1f652cb3c1d695c1a7cb556f20002a";
    let adCloseTimerInterval;
    let adCloseTimeout;
    let currentAdCallback = null;

    function showInterstitialAd(callback) {
        console.log("showInterstitialAd called");
        currentAdCallback = callback;

        adInfoText.textContent = "Advertisement loading in a new tab...";
        interstitialAdOverlay.style.display = 'flex';
        interstitialAdCloseButton.style.display = 'none';
        interstitialAdTimer.textContent = "";

        try {
             const adWindow = window.open(directLinkUrl, '_blank');
             if (!adWindow) {
                 console.warn("Pop-up blocked? Could not open ad window.");
                 adInfoText.textContent = "Please disable pop-up blockers to view the ad.";
             }
        } catch (e) {
            console.error("Error opening ad window:", e);
            adInfoText.textContent = "Could not open ad window.";
        }

        let secondsRemaining = 3; // Keep timer duration reasonable
        interstitialAdTimer.textContent = `You can skip in ${secondsRemaining} seconds`;

        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        if (adCloseTimeout) clearTimeout(adCloseTimeout);

        adCloseTimerInterval = setInterval(() => {
            secondsRemaining--;
            if (secondsRemaining > 0) {
                interstitialAdTimer.textContent = `You can skip in ${secondsRemaining} second${secondsRemaining > 1 ? 's' : ''}`;
            } else {
                 interstitialAdTimer.textContent = "You can return to the game now.";
                 clearInterval(adCloseTimerInterval);
            }
        }, 1000);

        // Show skip button after timer
        adCloseTimeout = setTimeout(() => {
            interstitialAdCloseButton.style.display = 'block';
             if (adCloseTimerInterval) clearInterval(adCloseTimerInterval); // Ensure timer stops
             interstitialAdTimer.textContent = "You can return to the game now.";
        }, secondsRemaining * 1000); // Use variable for timeout
    }

    interstitialAdCloseButton.addEventListener('click', () => {
        console.log("Interstitial Close Button clicked");
        interstitialAdOverlay.style.display = 'none';
        if (adCloseTimerInterval) clearInterval(adCloseTimerInterval);
        if (adCloseTimeout) clearTimeout(adCloseTimeout);
        interstitialAdTimer.textContent = "";

        if (typeof currentAdCallback === 'function') {
            console.log("Executing ad callback function.");
            try {
                currentAdCallback();
            } catch(e) {
                 console.error("Error executing ad callback:", e);
            }
            currentAdCallback = null; // Reset callback
        } else {
            console.warn("No callback function found after closing ad overlay.");
        }
    });
    // --- AD INTEGRATION END ---


    /***** Login/Signup Panel *****/
    document.getElementById("loginButton").addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            showInterstitialAd(() => { // Show ad AFTER successful login attempt
                document.getElementById("loginPanel").style.display = "none";
                loadUserCoins();
                loadInviteCode(); // Load invite code after login
                showMainMenu();
                checkUrlForReferral(); // Check URL for referral after login
            });
        })
        .catch((error) => { alert("Login Error: " + error.message); });
    });

    document.getElementById("signupButton").addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          // Set initial user data in Firebase
          set(ref(db, "users/" + user.uid), {
            email: user.email,
            uid: user.uid,
            totalCoins: 0, // Start with 0 coins
            referralCount: 0,
            referralRedeemed: false // Explicitly set to false initially
            // inviteCode will be generated on first loadInviteCode call
          }).then(() => {
            showInterstitialAd(() => { // Show ad AFTER successful signup & data creation
                document.getElementById("loginPanel").style.display = "none";
                loadUserCoins(); // Should load 0 initially
                loadInviteCode(); // Load/Generate invite code after signup
                showMainMenu();
                checkUrlForReferral(); // Check URL for referral after signup
            });
          }).catch(dbError => {
              alert("Sign up successful, but failed to save initial data: " + dbError.message);
              // Still proceed to main menu, but log error
              document.getElementById("loginPanel").style.display = "none";
              showMainMenu(); // Might not have coins/invite code initially
          });
        })
        .catch((error) => { alert("Sign Up Error: " + error.message); });
    });

    document.getElementById("guestButton").addEventListener("click", () => {
        // No ad for guest login directly, maybe show one on first game start instead?
        document.getElementById("loginPanel").style.display = "none";
        loadUserCoins(); // Will load 0 for guest
        showMainMenu();
        checkUrlForReferral(); // Check URL even for guest (won't prefill)
    });

    // Auth State Change Listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in.
        console.log("User logged in:", user.uid);
        loadUserCoins();
        loadInviteCode();
        // If the login panel is already hidden (e.g., page refresh while logged in), show main menu
        if (document.getElementById("loginPanel").style.display !== "flex") {
             showMainMenu();
             checkUrlForReferral(); // Check URL if user is already logged in
        }
      } else {
          // User is signed out.
          console.log("User logged out or not logged in.");
          document.getElementById("loginPanel").style.display = "flex";
          document.getElementById("mainMenu").style.display = "none";
          document.getElementById("gameCanvas").style.display = 'none';
          document.getElementById("gameOverMenu").style.display = 'none'; // Ensure game over is hidden
          // Reset UI elements for guest state
          document.getElementById("menuCoinCount").innerText = "0";
          updateInviteButtonText(0);
          document.getElementById("yourInviteCode").textContent = "N/A (Guest)";
          currentUserInviteCode = null;
          totalCoins = 0; // Reset local coin count
      }
    });

    let totalCoins = 0;
    function loadUserCoins() {
      const user = auth.currentUser;
      if (user) {
        const userRef = ref(db, "users/" + user.uid + "/totalCoins");
        get(userRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              totalCoins = snapshot.val();
            } else {
              console.warn("User coin data not found in DB for UID:", user.uid, "Setting to 0.");
              totalCoins = 0;
               // Optionally set it in the database if it's missing
               // set(userRef, 0);
            }
             document.getElementById("menuCoinCount").innerText = totalCoins;
             // Update game over screen if it's visible (though usually called before game over)
             if (document.getElementById("gameOverMenu").style.display === 'flex') {
                 document.getElementById("finalTotalCoins").innerText = totalCoins;
             }
          })
          .catch((error) => {
              console.error("Error loading coins:", error);
              totalCoins = 0; // Default to 0 on error
              document.getElementById("menuCoinCount").innerText = totalCoins;
           });
      } else {
        // Guest user or logged out
        totalCoins = 0;
        document.getElementById("menuCoinCount").innerText = totalCoins;
      }
    }

    /***** Sound Settings *****/
    let soundEnabled = true; // Default to ON
    const backgroundAudio = document.getElementById("backgroundAudio");
    backgroundAudio.volume = 0.2; // Lower volume
    const toggleSoundBtn = document.getElementById("toggleSound");

    function updateSoundButton() {
        toggleSoundBtn.textContent = `Sound: ${soundEnabled ? 'On' : 'Off'}`;
        // Change button style based on state
        if (soundEnabled) {
            toggleSoundBtn.style.background = 'linear-gradient(145deg, #2ed573, #1dd1a1)';
            toggleSoundBtn.style.borderBottomColor = '#10ac84';
        } else {
            toggleSoundBtn.style.background = 'linear-gradient(145deg, #8395a7, #576574)';
            toggleSoundBtn.style.borderBottomColor = '#2f3640';
        }
    }

    function playBackgroundMusic() {
        if (soundEnabled && backgroundAudio.paused) { // Only play if paused
            backgroundAudio.play().catch(error => {
                console.log("Background audio playback prevented by browser:", error);
                // User might need to interact first. Don't force sound off here.
            });
        }
    }
    function stopBackgroundMusic() {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0; // Reset playback position
    }

    // Initial button state
    updateSoundButton();

    /***** Settings Modal Logic *****/
    document.getElementById("settingsBtn").addEventListener("click", () => {
      document.getElementById("settingsModal").style.display = "block";
    });
    document.getElementById("closeSettings").addEventListener("click", () => {
      document.getElementById("settingsModal").style.display = "none";
    });
    toggleSoundBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      updateSoundButton(); // Update button text and style
      if (soundEnabled) {
        // If game is running, start music, otherwise it will start when game starts
        if (gameStarted && !gameOver) {
             playBackgroundMusic();
        }
      } else {
        stopBackgroundMusic();
      }
    });
    document.getElementById("customerService").addEventListener("click", () => {
      window.open("https://wa.me/923019022815", "_blank"); // Open in new tab
    });

    /***** Invite Friend Logic *****/
    let currentUserInviteCode = null; // Store the user's code
    const baseInviteUrl = window.location.origin + window.location.pathname; // Use current page URL as base

    function generateRandomCode() {
      // Generates a 6-character uppercase alphanumeric code
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function loadInviteCode() {
      const user = auth.currentUser;
      const inviteCodeDisplay = document.getElementById("yourInviteCode");
      if (user) {
        const userRef = ref(db, "users/" + user.uid);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (!data.inviteCode) {
              // Generate and save a new code if one doesn't exist
              const newCode = generateRandomCode();
              set(ref(db, "users/" + user.uid + "/inviteCode"), newCode)
                .then(() => {
                    currentUserInviteCode = newCode;
                    inviteCodeDisplay.textContent = newCode;
                    console.log("Generated and saved new invite code:", newCode);
                }).catch(e => {
                    console.error("Failed to set invite code:", e);
                    inviteCodeDisplay.textContent = "Error";
                    currentUserInviteCode = null;
                });
            } else {
              currentUserInviteCode = data.inviteCode;
              inviteCodeDisplay.textContent = currentUserInviteCode;
            }
            loadReferralCount(); // Load count after getting code info
          } else {
              console.warn("User data node not found for invite code loading (UID:", user.uid, ")");
              inviteCodeDisplay.textContent = "Error";
              currentUserInviteCode = null;
              loadReferralCount(); // Still try to load count (should be 0)
          }
        }).catch(e => {
            console.error("Failed to get user data for invite code:", e);
            inviteCodeDisplay.textContent = "Error";
            currentUserInviteCode = null;
        });
      } else {
        // Guest or logged out
        inviteCodeDisplay.textContent = "N/A (Guest)";
        currentUserInviteCode = null;
        updateInviteButtonText(0); // Guests have 0 referrals
      }
    }

    // Check URL for referral code on load (or after login)
    function checkUrlForReferral() {
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        const user = auth.currentUser;

        if (refCode && user) {
            const redeemInput = document.getElementById("redeemCodeInput");
            if (redeemInput) {
                redeemInput.value = refCode.trim().toUpperCase();
                console.log("Referral code found in URL and pre-filled:", refCode);

                // Clean the URL (optional: removes the ?ref=... part)
                 try {
                    const nextURL = window.location.pathname;
                    window.history.replaceState({}, document.title, nextURL);
                 } catch (e) {
                    console.warn("Could not clean referral code from URL:", e);
                 }

            } else {
                console.log("Referral code found, but redeem input field not available yet.");
            }
        } else if (refCode && !user) {
             console.log("Referral code found in URL, but user is not logged in. Will not pre-fill.");
             // Optionally store it temporarily and try pre-filling after login
        }
    }

    function loadReferralCount() {
      const user = auth.currentUser;
      if (user) {
        get(ref(db, "users/" + user.uid + "/referralCount")).then((snap) => {
          let count = snap.exists() ? snap.val() : 0;
          updateInviteButtonText(count);
        }).catch(e => {
            console.error("Failed to load referral count:", e);
            updateInviteButtonText(0); // Default to 0 on error
        });
      } else {
          updateInviteButtonText(0); // Guests have 0 referrals
      }
    }
    function updateInviteButtonText(count) {
      // Update the text inside the "Invite Friend" button
      document.getElementById("inviteFriend").innerText = "Invite (" + (count || 0) + " Refs)";
    }

    function redeemInviteCode(code) {
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to redeem an invite code.");
        return;
      }

      // 1. Check if the current user has already redeemed a code
      get(ref(db, "users/" + user.uid + "/referralRedeemed")).then((redeemedSnap) => {
        if (redeemedSnap.exists() && redeemedSnap.val() === true) {
          alert("You have already redeemed a referral code.");
          return;
        }

        // 2. Find the user (referrer) who owns this code
        const inviteQuery = query(ref(db, "users"), orderByChild("inviteCode"), equalTo(code));
        get(inviteQuery).then((snapshot) => {
          if (!snapshot.exists()) {
            alert("Invalid invite code.");
            return;
          }

          let referrerId = null;
          let referrerData = null;
          snapshot.forEach(childSnapshot => {
            // Ensure the found user is not the current user trying to redeem their own code
            if(childSnapshot.key !== user.uid) {
                referrerId = childSnapshot.key;
                referrerData = childSnapshot.val();
            }
          });

          if (!referrerId || !referrerData) {
            alert("Invalid invite code or you cannot redeem your own code.");
            return;
          }

          // 3. Check if the referrer has reached the referral limit (e.g., 10)
          let currentReferralCount = referrerData.referralCount || 0;
          if (currentReferralCount >= 10) {
            alert("This referral code has reached its maximum usage (10 users). Please try another code.");
            return;
          }

          // 4. Perform the redemption: Update coins and statuses
          const redeemerBonus = 200;
          const referrerBonus = 100;
          let newRedeemerCoins = totalCoins + redeemerBonus;

          // Use Promise.all to handle multiple database updates more robustly
          Promise.all([
              set(ref(db, "users/" + user.uid + "/totalCoins"), newRedeemerCoins), // Update redeemer coins
              set(ref(db, "users/" + user.uid + "/referralRedeemed"), true),      // Mark redeemer as redeemed
              set(ref(db, "users/" + referrerId + "/totalCoins"), (referrerData.totalCoins || 0) + referrerBonus), // Update referrer coins
              set(ref(db, "users/" + referrerId + "/referralCount"), currentReferralCount + 1) // Increment referrer count
          ]).then(() => {
              totalCoins = newRedeemerCoins; // Update local coin count
              document.getElementById("menuCoinCount").innerText = totalCoins; // Update UI
              loadReferralCount(); // Refresh referrer's count display (if they are the current user, unlikely but possible)
              alert(`Invite code redeemed successfully! You received ${redeemerBonus} coins. The referrer received ${referrerBonus} coins.`);
              document.getElementById("inviteModal").style.display = "none"; // Close modal
              document.getElementById("redeemCodeInput").value = ""; // Clear input
          }).catch(error => {
              alert("Error completing redemption: " + error.message);
              console.error("Error during multi-set redemption:", error);
              // Consider how to handle partial failures if necessary
          });

        }).catch((error) => {
          console.error("Error querying for invite code: ", error);
          alert("Error checking invite code: " + error.message);
        });
      }).catch(error => {
        alert("Error checking your referral status: " + error.message);
        console.error("Error checking referralRedeemed status:", error);
      });
    }

    // --- Invite Modal Event Listeners ---
    document.getElementById("inviteFriend").addEventListener("click", () => {
      if (!auth.currentUser) {
          alert("Please log in to use the invite feature.");
          return;
      }
      // Ensure the latest code and count are displayed when opening
      loadInviteCode();
      document.getElementById("inviteModal").style.display = "block";
    });

    document.getElementById("closeInviteModal").addEventListener("click", () => {
      document.getElementById("inviteModal").style.display = "none";
    });

    document.getElementById("copyInviteCode").addEventListener("click", () => {
       if (currentUserInviteCode && currentUserInviteCode !== "Loading..." && currentUserInviteCode !== "N/A (Guest)" && currentUserInviteCode !== "Error") {
            const inviteLink = `${baseInviteUrl}?ref=${currentUserInviteCode}`; // Construct the full link
            navigator.clipboard.writeText(inviteLink).then(() => {
                alert("Invite link copied to clipboard! Share it with friends."); // Updated alert message
            }).catch(err => {
                alert("Failed to copy link. Please copy it manually.");
                console.error('Clipboard copy failed: ', err);
                // Optionally display the link in a read-only input for manual copying
            });
       } else {
           alert("Invite code/link not available. Please ensure you are logged in and the code has loaded.");
       }
    });

    document.getElementById("redeemCodeBtn").addEventListener("click", () => {
      const codeInput = document.getElementById("redeemCodeInput");
      const code = codeInput.value.trim().toUpperCase(); // Ensure consistent casing
      if (code === "") {
        alert("Please enter an invite code.");
        return;
      }
      if (code === currentUserInviteCode) {
          alert("You cannot redeem your own invite code.");
          return;
      }
      redeemInviteCode(code);
    });
    // (End of Invite Logic Section)


    /***** Game Code *****/
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        // Use the actual height of the banner ad container
        const bannerHeight = document.getElementById('bannerAdContainer')?.offsetHeight || 50; // Default to 50 if not found
        canvas.height = window.innerHeight - bannerHeight;

        // Adjust Mario's position if the canvas resizes, especially ground level
        if (mario) {
             const groundY = canvas.height - 50; // Ground position relative to new height
             // If Mario is on the ground or below, snap him to the new ground position
             if (mario.y + mario.height > groundY || !mario.isJumping) {
                 mario.y = groundY - mario.height;
                 mario.dy = 0; // Stop vertical movement if snapped to ground
                 mario.isJumping = false;
                 canDoubleJump = false;
             }
        }
    }
    // Initial resize and add listener for changes
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas(); // Call once initially

    let gameStarted = false;
    let mario, obstacles, coins, speed, score, gameOver;
    let bgX = 0;
    let platformX = 0;

    // --- Double Jump Variables ---
    let lastJumpInputTime = 0;
    const doubleJumpWindow = 350; // milliseconds allowed between jumps for a double jump (slightly longer)
    let canDoubleJump = false;
    // --- End Double Jump Variables ---

    // Preload images and handle loading state
    const imagesToLoad = {
        character: "https://i.imgur.com/AbfH2aB.png",
        background: "https://i.imgur.com/xZpZqGt.png",
        enemy: "https://i.imgur.com/TsR4WXH.png",
        coin: "https://i.imgur.com/cMQ9X0d.png",
        platform: "https://i.imgur.com/06ptzal.png"
    };
    const gameImages = {};
    let imagesLoadedCount = 0;
    let totalImagesToLoad = Object.keys(imagesToLoad).length;
    let allImagesLoaded = false;

    function checkAllImagesLoaded() {
        imagesLoadedCount++;
        if (imagesLoadedCount === totalImagesToLoad) {
            allImagesLoaded = true;
            console.log("All game images loaded successfully.");
            // You could enable the "Play Now" button here if it was disabled
        }
    }

    for (const key in imagesToLoad) {
        gameImages[key] = new Image();
        gameImages[key].onload = checkAllImagesLoaded;
        gameImages[key].onerror = () => {
            console.error("Failed to load image:", key, imagesToLoad[key]);
            // Handle image loading error - maybe show a placeholder or alert
            totalImagesToLoad--; // Reduce count so loading might still "complete"
        };
        gameImages[key].src = imagesToLoad[key];
    }


    function init() {
      if (!allImagesLoaded) {
          console.warn("Attempted to init game before images loaded.");
          // Optionally show a loading indicator or wait
          return;
      }
      resizeCanvas(); // Ensure canvas size is correct before placing elements
      bgX = 0;
      platformX = 0;
      const groundY = canvas.height - 50; // Platform height is 50px
      mario = {
        x: 60, // Start slightly further in
        y: groundY - 60, // Initial y position above ground (mario height 60)
        width: 40,
        height: 60,
        dy: 0, // Vertical velocity
        gravity: 1.6, // Slightly stronger gravity
        jumpPower: -22, // Stronger initial jump
        doubleJumpPower: -18, // Double jump is less strong than initial jump
        isJumping: false
      };
      obstacles = [];
      coins = [];
      speed = 6; // Slightly faster base speed
      score = 0;
      gameOver = false;
      gameStarted = true;
      lastJumpInputTime = 0; // Reset jump timer
      canDoubleJump = false; // Reset double jump capability

      // Immediately place first obstacle further away
      spawnObstacles(canvas.width * 1.5);

      console.log("Game Initialized. Canvas H:", canvas.height, "Ground Y:", groundY, "Mario Y:", mario.y);

      // Ensure music starts if enabled
      if (soundEnabled) playBackgroundMusic();
    }

    function drawBackground() {
      if (!gameImages.background?.complete || gameImages.background.naturalWidth === 0) return;
      // Parallax effect: background moves slower than platform
      bgX = (bgX - speed * 0.4) % gameImages.background.width; // Use image width for seamless loop
      ctx.drawImage(gameImages.background, bgX, 0, gameImages.background.width, canvas.height);
      // Draw second image for wrapping
      ctx.drawImage(gameImages.background, bgX + gameImages.background.width, 0, gameImages.background.width, canvas.height);
    }

    function drawPlatform() {
       if (!gameImages.platform?.complete || gameImages.platform.naturalWidth === 0) return;
       const groundY = canvas.height - 50;
       platformX = (platformX - speed) % gameImages.platform.width; // Use image width for seamless loop
       ctx.drawImage(gameImages.platform, platformX, groundY, gameImages.platform.width, 50);
       // Draw second image for wrapping
       ctx.drawImage(gameImages.platform, platformX + gameImages.platform.width, groundY, gameImages.platform.width, 50);
    }

    function drawMario() {
       if (!mario || !gameImages.character?.complete || gameImages.character.naturalWidth === 0) return;
       // Simple draw for now, could add animation frames later
       ctx.drawImage(gameImages.character, mario.x, mario.y, mario.width, mario.height);
    }

    function drawObstacles() {
      if (!gameImages.enemy?.complete || gameImages.enemy.naturalWidth === 0) return;
      for (let i = obstacles.length - 1; i >= 0; i--) {
        let obstacle = obstacles[i];
        obstacle.x -= speed; // Move obstacle left
        ctx.drawImage(gameImages.enemy, obstacle.x, obstacle.y, obstacle.width, obstacle.height);

        // Remove obstacles that are off-screen to the left
        if (obstacle.x + obstacle.width < 0) {
            obstacles.splice(i, 1);
        }
      }
    }

    function spawnCoins() {
        if (!gameImages.coin?.complete || gameImages.coin.naturalWidth === 0) return;
        // Increase spawn rate slightly, maybe based on score/time?
        const spawnChance = 0.02 + Math.min(score / 1000, 0.02); // Slightly increases chance with score

        if (coins.length < 25 && Math.random() < spawnChance) { // Max 25 coins on screen
            const groundY = canvas.height - 50; // Reference ground
            // Spawn height variation: Can be on ground or higher up
            let spawnY = groundY - 30; // Default above ground
            if (Math.random() < 0.4) { // 40% chance to spawn higher
                 spawnY = groundY - 70 - (Math.random() * 60); // Higher cluster
            }

            let clusterSize = Math.floor(Math.random() * 4) + 2; // 2 to 5 coins per cluster
            let startX = canvas.width + Math.random() * 100; // Start off-screen right
            const spacing = 45; // Space between coins

            for (let i = 0; i < clusterSize; i++) {
                coins.push({
                    x: startX + i * spacing,
                    y: spawnY,
                    width: 25, // Slightly larger coins
                    height: 25
                });
            }
        }
    }

    function drawCoins() {
        if (!gameImages.coin?.complete || gameImages.coin.naturalWidth === 0 || !mario) return;
        const user = auth.currentUser; // Check if user is logged in

        for (let i = coins.length - 1; i >= 0; i--) {
            let coin = coins[i];
            coin.x -= speed; // Move coin left with the screen

            // Draw the coin
            ctx.drawImage(gameImages.coin, coin.x - coin.width / 2, coin.y - coin.height / 2, coin.width, coin.height);

            // Collision detection with Mario (using center points might be slightly better)
            // AABB Collision Check (Axis-Aligned Bounding Box)
            if (
                mario.x < coin.x + coin.width / 2 &&
                mario.x + mario.width > coin.x - coin.width / 2 &&
                mario.y < coin.y + coin.height / 2 &&
                mario.y + mario.height > coin.y - coin.height / 2
            ) {
                // Collision occurred
                coins.splice(i, 1); // Remove the coin
                score += 1; // Increment session score

                // If logged in, increment total coins as well
                if (user) {
                    totalCoins += 1;
                    // Update UI immediately for responsiveness (optional, could batch update)
                    document.getElementById("menuCoinCount").innerText = totalCoins;
                    // Also update the game over screen's total coin display in real-time
                    document.getElementById("finalTotalCoins").innerText = totalCoins;
                }
            } else if (coin.x + coin.width < 0) {
                 // Remove coins that are off-screen to the left
                 coins.splice(i, 1);
            }
        }
    }


    function applyPhysics() {
        if (!mario) return;
        // Apply gravity
        mario.dy += mario.gravity;
        // Update vertical position
        mario.y += mario.dy;

        const groundY = canvas.height - 50; // Ground level

        // Ground collision
        if (mario.y + mario.height >= groundY) {
            mario.y = groundY - mario.height; // Snap to ground
            mario.dy = 0; // Stop vertical movement
            if (mario.isJumping) { // Only reset jump state if landing
                 mario.isJumping = false;
                 canDoubleJump = false; // Cannot double jump once landed
            }
        }

        // Ceiling collision (prevent going off top)
        if (mario.y < 0) {
            mario.y = 0;
            mario.dy = 0; // Stop upward movement if hitting the top
        }
    }

    function spawnObstacles(initialX = canvas.width) {
        // Don't spawn if game over or images not ready
        if (gameOver || !gameImages.enemy?.complete || gameImages.enemy.naturalWidth === 0) return;

        // Dynamic difficulty: spawn obstacles closer together as score increases
        const minDistance = 300; // Minimum distance between obstacles
        const maxDistance = 600;
        const scoreFactor = Math.max(0, 1 - (score / 500)); // Reduces distance as score increases, caps at 0 reduction
        const distanceRange = (maxDistance - minDistance) * scoreFactor;
        const randomDistance = minDistance + Math.random() * distanceRange;

        let lastObstacleX = obstacles.length > 0 ? obstacles[obstacles.length - 1].x : 0;
        let nextSpawnX = Math.max(initialX, lastObstacleX + randomDistance); // Ensure minimum distance

        // Only spawn if the calculated position is off-screen right
        if (nextSpawnX > lastObstacleX && nextSpawnX < canvas.width * 2) { // Check if reasonable spawn needed
             if (obstacles.length < 5 && (obstacles.length === 0 || canvas.width - lastObstacleX > minDistance * 0.8)) {
                const groundY = canvas.height - 50;
                obstacles.push({
                    x: nextSpawnX,
                    y: groundY - 50, // Enemy height is 50
                    width: 50,
                    height: 50
                });
             }
        } else if (obstacles.length === 0) { // Force spawn first obstacle if needed
            const groundY = canvas.height - 50;
             obstacles.push({
                x: initialX, // Use provided initialX or default canvas width
                y: groundY - 50,
                width: 50,
                height: 50
            });
        }
    }


    function checkCollision() {
      if (!mario || gameOver) return; // Don't check if already game over

      for (let i = obstacles.length - 1; i >= 0; i--) {
        let obstacle = obstacles[i];
        // Simple AABB collision check
        if (
          mario.x < obstacle.x + obstacle.width &&
          mario.x + mario.width > obstacle.x &&
          mario.y < obstacle.y + obstacle.height &&
          mario.y + mario.height > obstacle.y
        ) {
            // Collision!
            gameOver = true; // Set game over flag
            console.log("Collision Detected with obstacle!");
            // Play sound effect maybe?
            stopBackgroundMusic(); // Stop music on game over
            break; // No need to check other obstacles
        }
      }
    }

    let animationFrameId = null;

    function gameLoop() {
        // Stop loop if game ended
        if (gameOver) {
            handleGameOver(); // Process game over state
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            return;
        }
        if (!gameStarted) { // Should not happen if logic is correct, but safety check
             if (animationFrameId) cancelAnimationFrame(animationFrameId);
             animationFrameId = null;
             return;
        }

        // --- Game Logic Update Phase ---
        applyPhysics();
        checkCollision(); // Check collision AFTER physics update
        spawnObstacles(); // Spawn new obstacles if needed
        spawnCoins();     // Spawn new coins if needed

        // --- Drawing Phase ---
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas
        drawBackground();
        drawPlatform();
        drawObstacles(); // Draw obstacles before Mario/coins
        drawCoins();     // Draw coins before Mario (so Mario is on top)
        drawMario();

        // --- UI Update Phase ---
        // Draw Score
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "20px 'Press Start 2P', cursive"; // Slightly smaller for gameplay
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.shadowColor = 'black';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.fillText("Score: " + score, 20, 20);
        ctx.shadowBlur = 0; // Reset shadow for other elements if needed
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        // Speed increase over time/score (optional, subtle)
        // speed = Math.min(10, 6 + score / 200);


        // Request next frame
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    function handleGameOver() {
         console.log("Handling Game Over. Final Session Score:", score);
         gameStarted = false; // Mark game as not running
         const user = auth.currentUser;

         // Save final coin count to Firebase ONLY if logged in and score > 0
         if (user && score > 0) {
             console.log(`Attempting to save ${totalCoins} total coins to Firebase.`);
             set(ref(db, "users/" + user.uid + "/totalCoins"), totalCoins)
                .then(() => console.log("Final coins saved successfully to Firebase:", totalCoins))
                .catch(e => console.error("Error saving final coins to Firebase:", e));
         } else if (user && score === 0) {
             console.log("Game Over, but no coins earned this session. No Firebase update needed.");
         } else {
             console.log("Game Over for Guest. Final score:", score, "Coins not saved.");
         }

         // Stop music is already handled in checkCollision or here as fallback
         stopBackgroundMusic();

         // Show the game over menu
         showGameOverMenu();
    }

    // --- UPDATED JUMP FUNCTION with Double Jump ---
    function jump() {
        // Guard conditions: Don't jump if game not started, over, or mario doesn't exist
        if (!gameStarted || gameOver || !mario) return;

        const currentTime = Date.now();
        const groundY = canvas.height - 50;
        // Check if Mario is on or very close to the ground (allows jumping slightly before landing)
        const onGround = mario.y + mario.height >= groundY - 5;

        // --- Double Jump Logic ---
        // Condition: Mario must be in the air (isJumping=true), allowed to double jump (canDoubleJump=true),
        // AND the jump input must be within the time window since the *last jump input*.
        if (mario.isJumping && canDoubleJump && (currentTime - lastJumpInputTime < doubleJumpWindow)) {
             console.log("Double Jump!");
             mario.dy = mario.doubleJumpPower; // Apply double jump strength
             canDoubleJump = false; // Consume the double jump ability for this jump sequence
             lastJumpInputTime = 0; // Reset timer immediately to prevent triple/rapid jumps
             // Play double jump sound effect?
        }
        // --- First Jump Logic ---
        // Condition: Mario must be on the ground.
        else if (onGround) {
            console.log("First Jump!");
            mario.dy = mario.jumpPower; // Apply normal jump strength
            mario.isJumping = true;    // Mario is now in the air
            canDoubleJump = true;     // Allow a double jump *after* this initial jump
            lastJumpInputTime = currentTime; // Record the time of this jump input
            // Play jump sound effect?
        }
    }
    // --- End Updated Jump Function ---

    // --- Event Listeners for Jump ---
    document.addEventListener("keydown", (e) => {
      // Use 'Space' or 'ArrowUp' for jump
      if ((e.code === "Space" || e.code === "ArrowUp") && gameStarted && !gameOver) {
          e.preventDefault(); // Prevent space bar from scrolling page
          jump();
      }
    });
    // Use 'click' or 'touchstart' for mobile/touch controls
    canvas.addEventListener("click", (e) => {
         if (gameStarted && !gameOver) {
             e.preventDefault();
             jump();
         }
    });
     canvas.addEventListener("touchstart", (e) => {
         // Use touchstart for faster response on mobile
         if (gameStarted && !gameOver) {
             e.preventDefault(); // Prevent default touch behavior (like scrolling)
             jump();
         }
    }, { passive: false }); // Need passive: false to call preventDefault


    function showMainMenu() {
      gameStarted = false; // Ensure game loop stops
      gameOver = false;
      if(animationFrameId) {
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
      }
      loadUserCoins(); // Refresh coin count from DB potentially
      resizeCanvas(); // Ensure canvas is sized correctly even if returning from game
      document.getElementById("mainMenu").style.display = "flex"; // Show main menu
      document.getElementById("gameOverMenu").style.display = "none"; // Hide game over
      document.getElementById("loginPanel").style.display = "none"; // Hide login
      document.getElementById("gameCanvas").style.display = 'none'; // Hide canvas
      document.getElementById("settingsModal").style.display = "none"; // Hide modals
      document.getElementById("inviteModal").style.display = "none";
      document.getElementById("withdrawModal").style.display = "none";
      document.getElementById("infoModal").style.display = "none";

      stopBackgroundMusic(); // Ensure music is stopped when returning to menu
    }

    function showGameOverMenu() {
      // Update the text fields in the game over menu
      document.getElementById("sessionCoinCount").innerText = score; // Show score from the ended session
      document.getElementById("finalTotalCoins").innerText = totalCoins; // Show the updated total coins

      // Display the game over menu
      document.getElementById("gameOverMenu").style.display = "flex";
      // Keep the canvas visible briefly behind the overlay? Or hide it?
      // document.getElementById("gameCanvas").style.display = 'block'; // Keep canvas visible
      document.getElementById("mainMenu").style.display = "none"; // Hide main menu
    }

    // --- Button Listeners Connecting UI and Game States (with Ads) ---

    // Start Game Button
    document.getElementById("startBtn").addEventListener("click", () => {
        if (!allImagesLoaded) {
            alert("Game assets are still loading, please wait a moment.");
            return;
        }
        // Show ad, then start game
        showInterstitialAd(() => {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("gameCanvas").style.display = 'block'; // Show canvas
            init(); // Initialize game variables
            if(animationFrameId) cancelAnimationFrame(animationFrameId); // Clear previous loop if any
            gameLoop(); // Start the game loop
        });
    });

    // Restart Game Button (from Game Over screen)
    document.getElementById("restartBtn").addEventListener("click", () => {
         if (!allImagesLoaded) { // Should be loaded, but check anyway
            alert("Game assets error. Cannot restart.");
            showMainMenu(); // Go back to menu if assets failed
            return;
        }
        // Show ad, then restart game
        showInterstitialAd(() => {
            document.getElementById("gameOverMenu").style.display = "none";
            document.getElementById("gameCanvas").style.display = 'block'; // Ensure canvas is visible
            init(); // Re-initialize game variables
            if(animationFrameId) cancelAnimationFrame(animationFrameId); // Clear previous loop if any
            gameLoop(); // Start the game loop again
        });
    });

    // Back to Menu Button (from Game Over screen)
    document.getElementById("backMenuBtn").addEventListener("click", () => {
        // No ad needed when just returning to menu
        showMainMenu();
    });

    /***** Redeem Modal Logic *****/
    const withdrawModal = document.getElementById("withdrawModal");
    const redeemOptionsDiv = document.getElementById("redeemOptions");
    const redeemFormDiv = document.getElementById("redeemForm");
    const redeemDetailsForm = document.getElementById("redeemDetailsForm");
    const redeemSubmitBtn = document.getElementById('redeemSubmitBtn');
    let selectedCoins = 0;
    let selectedPKR = 0;

    document.getElementById("withdrawBtn").addEventListener("click", () => {
        if (!auth.currentUser) {
            alert("Please log in to withdraw coins.");
            return;
        }
        loadUserCoins(); // Ensure local coin count is up-to-date
        // Reset modal state
        redeemOptionsDiv.style.display = "block";
        redeemFormDiv.style.display = "none";
        redeemDetailsForm.reset();
        redeemSubmitBtn.disabled = false;
        redeemSubmitBtn.textContent = "Submit Request";
        withdrawModal.style.display = "block";
    });

    document.getElementById("closeWithdraw").addEventListener("click", () => {
      withdrawModal.style.display = "none";
    });

    // Add listeners to all redeem option buttons
    redeemOptionsDiv.querySelectorAll('.redeem-option').forEach(button => {
      button.addEventListener('click', () => {
        selectedCoins = parseInt(button.getAttribute('data-coins'), 10);
        selectedPKR = parseInt(button.getAttribute('data-pkr'), 10);

        // Check if user has enough coins *before* showing the form
        if (totalCoins < selectedCoins) {
            alert(`Insufficient coins! You need ${selectedCoins} coins to redeem ${selectedPKR} PKR.\nYou currently have ${totalCoins} coins.`);
            return; // Don't proceed
        }

        // If sufficient coins, hide options and show the form
        redeemOptionsDiv.style.display = 'none';
        redeemFormDiv.style.display = 'block';
      });
    });

    // Handle form submission
    redeemDetailsForm.addEventListener('submit', (e) => {
      e.preventDefault(); // Prevent default form submission

      const accountHolderNameInput = document.getElementById('accountHolderName');
      const accountNumberInput = document.getElementById('accountNumber');
      const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');

      // Basic validation
      const accountHolderName = accountHolderNameInput.value.trim();
      const accountNumber = accountNumberInput.value.trim();
      if (!accountHolderName || !accountNumber || !paymentMethodInput) {
           alert("Please fill in all fields and select a payment method.");
           return;
      }

       // Final check for sufficient coins right before submission
       if (totalCoins < selectedCoins) {
            alert("Error: You no longer have enough coins for this redemption. Your balance might have changed.");
            withdrawModal.style.display = "none"; // Close modal
            return;
       }

      const paymentMethod = paymentMethodInput.value;
      const user = auth.currentUser;
      if (!user) { // Should not happen if button logic is correct, but safety check
          alert("Authentication error. Please log in again.");
          withdrawModal.style.display = "none";
          return;
      }

      // Prepare withdrawal request data
      const withdrawalRequest = {
        uid: user.uid,
        email: user.email || "Not available", // Include email if available
        withdrawalAmountCoins: selectedCoins,
        pkrAmount: selectedPKR,
        accountHolderName: accountHolderName,
        accountNumber: accountNumber,
        paymentMethod: paymentMethod,
        status: "pending", // Initial status
        timestamp: Date.now() // Record time of request
      };

      // Disable button and show loading state
      redeemSubmitBtn.disabled = true;
      redeemSubmitBtn.textContent = "Submitting...";

      // 1. Push the request to Firebase
      push(ref(db, "withdrawRequests"), withdrawalRequest)
        .then((newRequestRef) => {
          console.log("Withdrawal request submitted successfully, ref:", newRequestRef.key);
          // 2. If request submission is successful, deduct coins from user's balance
          const newTotalCoins = totalCoins - selectedCoins;
          return set(ref(db, "users/" + user.uid + "/totalCoins"), newTotalCoins); // Return this promise
        })
        .then(() => {
          // 3. If coin deduction is successful, update local state and UI
          totalCoins = totalCoins - selectedCoins; // Update local count *after* successful DB update
          document.getElementById("menuCoinCount").innerText = totalCoins; // Update main menu display
          alert(`Redemption request for ${selectedPKR} PKR submitted successfully! Your request is pending approval.`);
          withdrawModal.style.display = "none"; // Close modal on success
        })
        .catch((error) => {
            // Handle errors from either pushing request or deducting coins
            alert("Error processing redemption: " + error.message);
            console.error("Error during withdrawal process:", error);
            // Re-enable button if submission failed
             redeemSubmitBtn.disabled = false;
             redeemSubmitBtn.textContent = "Submit Request";
        });
        // Note: The finally block was removed as error handling is specific now.
        // Button state is reset on modal open or handled in catch block.
    });


    /***** Info Modal Logic *****/
    document.getElementById("infoBtn").addEventListener("click", () => {
      document.getElementById("infoModal").style.display = "block";
    });
    document.getElementById("closeInfo").addEventListener("click", () => {
      document.getElementById("infoModal").style.display = "none";
    });

    /***** Logout Logic *****/
    document.getElementById("logoutBtn").addEventListener("click", () => {
        // Optional: Ask for confirmation
        // if (!confirm("Are you sure you want to exit the game?")) {
        //     return;
        // }

      signOut(auth).then(() => {
          // Sign-out successful. Auth listener will handle UI changes.
          console.log("User signed out successfully.");
          // Explicitly stop game state just in case
          gameStarted = false;
          gameOver = false;
          if(animationFrameId) cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
          stopBackgroundMusic();
          // Auth listener should reset UI, but we can force login screen display
          document.getElementById("mainMenu").style.display = "none";
          document.getElementById("gameOverMenu").style.display = "none";
          document.getElementById("gameCanvas").style.display = "none";
          document.getElementById("loginPanel").style.display = "flex";
      })
      .catch((error) => {
          alert("Logout error: " + error.message);
          console.error("Logout error: ", error);
       });
    });

    // --- Initial Application State ---
    // Hide elements initially, Auth listener will show the correct view (login or main menu)
    document.getElementById("loginPanel").style.display = "none"; // Let auth listener show this if needed
    document.getElementById("mainMenu").style.display = "none";
    document.getElementById("gameCanvas").style.display = "none";
    document.getElementById("gameOverMenu").style.display = "none";
    // Modals also hidden by default via CSS (.modal class)

    console.log("Game script initialized. Waiting for auth state...");
    // Auth listener (onAuthStateChanged) is the primary entry point now.

  </script>
</body>
</html>